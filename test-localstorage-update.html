<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste LocalStorage Update</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.success {
            background: #28a745;
        }
        .button.warning {
            background: #ffc107;
            color: #000;
        }
        .button.danger {
            background: #dc3545;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            background: #e9ecef;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste LocalStorage Update - Status de Pedidos</h1>
        <p>Este teste verifica se o localStorage est√° sendo atualizado corretamente quando o status muda.</p>
        
        <div class="grid">
            <div>
                <h3>1. Criar Pedido de Teste</h3>
                <button class="button" onclick="criarPedidoTeste()">
                    Criar Pedido #TEST001
                </button>
                
                <h3>2. Simular Mudan√ßas de Status</h3>
                <button class="button warning" onclick="atualizarStatus('confirmado')">
                    ‚Üí Confirmado
                </button>
                <button class="button" onclick="atualizarStatus('preparando')">
                    ‚Üí Preparando
                </button>
                <button class="button success" onclick="atualizarStatus('pronto')">
                    ‚Üí Pronto
                </button>
                <button class="button success" onclick="atualizarStatus('saiu_para_entrega')">
                    ‚Üí Saiu para Entrega
                </button>
                <button class="button success" onclick="atualizarStatus('entregue')">
                    ‚Üí Entregue
                </button>
                <button class="button danger" onclick="atualizarStatus('cancelado')">
                    ‚Üí Cancelado
                </button>
                
                <h3>3. A√ß√µes</h3>
                <button class="button" onclick="verificarLocalStorage()">
                    üîç Verificar LocalStorage
                </button>
                <button class="button" onclick="abrirCardapio()">
                    üåê Abrir Card√°pio
                </button>
                <button class="button danger" onclick="limparTudo()">
                    üóëÔ∏è Limpar Tudo
                </button>
            </div>
            
            <div>
                <h3>Status Atual do LocalStorage:</h3>
                <div id="statusLocalStorage" class="status">
                    Clique em "Verificar LocalStorage" para ver o conte√∫do
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h3>Log de A√ß√µes:</h3>
        <div id="logAcoes" class="status">
            Aguardando a√ß√µes...
        </div>
    </div>

    <script>
        let pedidoAtual = null;
        let logMessages = [];

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logMessages.push(`[${timestamp}] ${message}`);
            document.getElementById('logAcoes').textContent = logMessages.slice(-10).join('\n');
        }

        function criarPedidoTeste() {
            pedidoAtual = {
                id: `test-${Date.now()}`,
                numero_pedido: "TEST001",
                status_pedido: "pendente",
                data_pedido: new Date().toISOString(),
                valor_total: 25.90,
                nome_cliente: "emanuel",
                telefone_cliente: "(12) 99999-9999"
            };

            // Salvar no localStorage
            const chave = 'pedidos_ativos_slug_emanuel';
            const pedidos = [pedidoAtual];
            localStorage.setItem(chave, JSON.stringify(pedidos));
            
            log(`‚úÖ Pedido criado: #${pedidoAtual.numero_pedido} com status "${pedidoAtual.status_pedido}"`);
            verificarLocalStorage();
        }

        function atualizarStatus(novoStatus) {
            if (!pedidoAtual) {
                log('‚ùå Erro: Nenhum pedido criado. Clique em "Criar Pedido" primeiro.');
                return;
            }

            const statusAnterior = pedidoAtual.status_pedido;
            pedidoAtual.status_pedido = novoStatus;
            pedidoAtual.updated_at = new Date().toISOString();

            // Atualizar no localStorage
            const chave = 'pedidos_ativos_slug_emanuel';
            const pedidos = [pedidoAtual];
            localStorage.setItem(chave, JSON.stringify(pedidos));
            
            log(`üîÑ Status atualizado: "${statusAnterior}" ‚Üí "${novoStatus}"`);
            verificarLocalStorage();
        }

        function verificarLocalStorage() {
            try {
                const chave = 'pedidos_ativos_slug_emanuel';
                const pedidosStr = localStorage.getItem(chave);
                
                if (!pedidosStr) {
                    document.getElementById('statusLocalStorage').textContent = '‚ùå Nenhum pedido no LocalStorage';
                    return;
                }

                const pedidos = JSON.parse(pedidosStr);
                
                if (pedidos.length === 0) {
                    document.getElementById('statusLocalStorage').textContent = 'üì≠ Array vazio no LocalStorage';
                    return;
                }

                const pedido = pedidos[0];
                const statusDiv = document.getElementById('statusLocalStorage');
                statusDiv.textContent = `‚úÖ Pedido encontrado:
ID: ${pedido.id}
N√∫mero: ${pedido.numero_pedido}
Status: ${pedido.status_pedido}
Data: ${new Date(pedido.data_pedido).toLocaleString('pt-BR')}
Cliente: ${pedido.nome_cliente}
Valor: R$ ${pedido.valor_total}

JSON completo:
${JSON.stringify(pedido, null, 2)}`;
                
                log(`üîç LocalStorage verificado: Status atual = "${pedido.status_pedido}"`);
                
            } catch (error) {
                document.getElementById('statusLocalStorage').textContent = `‚ùå Erro ao verificar: ${error.message}`;
                log(`‚ùå Erro ao verificar LocalStorage: ${error.message}`);
            }
        }

        function abrirCardapio() {
            window.open('http://localhost:5173/emanuel', '_blank');
            log('üåê Card√°pio aberto em nova aba');
        }

        function limparTudo() {
            const chaves = [
                'pedidos_ativos_slug_emanuel',
                'pedido_status_slug_emanuel',
                'pedido_backup_slug_emanuel'
            ];
            
            chaves.forEach(chave => {
                localStorage.removeItem(chave);
            });
            
            pedidoAtual = null;
            document.getElementById('statusLocalStorage').textContent = 'üóëÔ∏è LocalStorage limpo';
            log('üóëÔ∏è Todos os dados do LocalStorage foram removidos');
        }

        // Verificar automaticamente ao carregar
        window.onload = function() {
            verificarLocalStorage();
            log('üöÄ P√°gina carregada - pronto para testes');
        };

        // Verificar mudan√ßas no localStorage a cada 2 segundos
        setInterval(() => {
            if (pedidoAtual) {
                const chave = 'pedidos_ativos_slug_emanuel';
                const pedidosStr = localStorage.getItem(chave);
                if (pedidosStr) {
                    try {
                        const pedidos = JSON.parse(pedidosStr);
                        if (pedidos.length > 0 && pedidos[0].status_pedido !== pedidoAtual.status_pedido) {
                            log(`üîÑ Mudan√ßa detectada no LocalStorage: "${pedidoAtual.status_pedido}" ‚Üí "${pedidos[0].status_pedido}"`);
                            pedidoAtual = pedidos[0];
                            verificarLocalStorage();
                        }
                    } catch (error) {
                        // Ignorar erros de parsing
                    }
                }
            }
        }, 2000);
    </script>
</body>
</html>
