#!/bin/bash

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                ğŸ”¥ NEXO PEDIDOS - DEV                        â•‘
# â•‘              Build e Deploy para Desenvolvimento            â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# ConfiguraÃ§Ãµes
PROJECT_DIR="/root/nexo-pedidos"
LOG_FILE="/var/log/nexo-dev.log"
TIMESTAMP=$(date '+%d/%m/%Y %H:%M:%S')

# FunÃ§Ã£o de log
log() {
    echo "[$TIMESTAMP] $1" | tee -a "$LOG_FILE"
}

# FunÃ§Ã£o para exibir header
show_header() {
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                ğŸ”¥ NEXO PEDIDOS - DEV                        â•‘"
    echo "â•‘              Build e Deploy para Desenvolvimento            â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
}

# FunÃ§Ã£o para verificar se estÃ¡ na branch dev
check_branch() {
    cd "$PROJECT_DIR"
    CURRENT_BRANCH=$(git branch --show-current)
    
    if [ "$CURRENT_BRANCH" != "dev" ]; then
        echo "âš ï¸  ATENÃ‡ÃƒO: VocÃª nÃ£o estÃ¡ na branch 'dev'"
        echo "   Branch atual: $CURRENT_BRANCH"
        echo "   Recomendado: git checkout dev"
        echo ""
        read -p "Continuar mesmo assim? (y/N): " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "âŒ Deploy cancelado"
            exit 1
        fi
    fi
}

# FunÃ§Ã£o principal
main() {
    show_header
    
    log "ğŸ”¥ Iniciando deploy para DESENVOLVIMENTO"
    
    # Verificar se o diretÃ³rio do projeto existe
    if [ ! -d "$PROJECT_DIR" ]; then
        echo "âŒ Erro: DiretÃ³rio do projeto nÃ£o encontrado: $PROJECT_DIR"
        exit 1
    fi
    
    cd "$PROJECT_DIR"
    log "ğŸ“ DiretÃ³rio do projeto: $PROJECT_DIR"
    
    # Verificar branch
    check_branch
    
    # Verificar dependÃªncias
    log "ğŸ” Verificando dependÃªncias..."
    if [ ! -d "node_modules" ]; then
        log "ğŸ“¦ Instalando dependÃªncias do frontend..."
        npm install
        if [ $? -ne 0 ]; then
            echo "âŒ Erro ao instalar dependÃªncias do frontend"
            exit 1
        fi
    else
        log "âœ… DependÃªncias do frontend jÃ¡ instaladas"
    fi
    
    # Verificar dependÃªncias do backend
    if [ ! -d "backend/vendor" ]; then
        log "ğŸ“¦ Instalando dependÃªncias do backend..."
        cd backend && composer install && cd ..
        if [ $? -ne 0 ]; then
            echo "âŒ Erro ao instalar dependÃªncias do backend"
            exit 1
        fi
    else
        log "âœ… DependÃªncias do backend jÃ¡ instaladas"
    fi
    
    # Verificar arquivo .env
    if [ ! -f ".env" ]; then
        echo "âŒ Arquivo .env nÃ£o encontrado"
        echo "   Copie o arquivo .env.example e configure suas credenciais"
        exit 1
    fi
    log "âœ… Arquivo .env encontrado"
    
    # âœ… CORRIGIDO: Criar apenas estrutura bÃ¡sica de diretÃ³rios
    log "ğŸ“ Criando estrutura bÃ¡sica de diretÃ³rios..."
    mkdir -p backend/storage/{certificados,logs,pdf,xml,espelhos}
    
    # âŒ REMOVIDO: NÃ£o criar pastas 55 e 65 na raiz
    # mkdir -p backend/storage/pdf/{55,65}  # PROBLEMA: Criava na raiz!
    # mkdir -p backend/storage/xml/{55,65}  # PROBLEMA: Criava na raiz!
    
    log "âœ… Estrutura bÃ¡sica criada (sem pastas 55/65 na raiz)"
    
    # Build do frontend
    log "ğŸ”¨ Gerando build do frontend para DESENVOLVIMENTO..."
    npm run build
    if [ $? -ne 0 ]; then
        echo "âŒ Erro no build do frontend"
        exit 1
    fi
    log "âœ… Build gerado com sucesso em /dist"
    
    # Configurar permissÃµes
    log "ğŸ” Configurando permissÃµes..."
    sudo chown -R www-data:www-data backend/storage/
    sudo chmod -R 755 backend/storage/
    sudo chown -R www-data:www-data dist/
    sudo chmod -R 755 dist/
    
    # Verificar configuraÃ§Ã£o Nginx
    log "ğŸŒ Verificando configuraÃ§Ã£o Nginx..."
    if [ -f "/etc/nginx/sites-available/nexo-pedidos" ]; then
        log "âœ… ConfiguraÃ§Ã£o Nginx encontrada"
    else
        echo "âš ï¸  ConfiguraÃ§Ã£o Nginx nÃ£o encontrada"
        echo "   Execute a configuraÃ§Ã£o inicial do Nginx"
    fi
    
    # Verificar serviÃ§os
    log "ğŸ”§ Verificando serviÃ§os..."
    
    # PHP-FPM
    if systemctl is-active --quiet php8.3-fpm; then
        log "âœ… PHP-FPM estÃ¡ rodando"
    else
        log "âš ï¸ PHP-FPM nÃ£o estÃ¡ rodando"
        echo "â„¹ï¸ Execute: sudo systemctl start php8.3-fpm"
    fi
    
    # Nginx
    if systemctl is-active --quiet nginx; then
        log "âœ… Nginx estÃ¡ rodando"
    else
        log "âš ï¸ Nginx nÃ£o estÃ¡ rodando"
        echo "â„¹ï¸ Execute: sudo systemctl start nginx"
    fi
    
    # Recarregar Nginx
    log "ğŸ”„ Recarregando configuraÃ§Ã£o Nginx..."
    sudo systemctl reload nginx
    
    # Testar endpoints
    log "ğŸ§ª Testando endpoints..."
    
    # Teste frontend
    if curl -s -f "http://nexodev.emasoftware.app" > /dev/null; then
        log "âœ… Frontend acessÃ­vel em http://nexodev.emasoftware.app"
    else
        log "âš ï¸ Frontend pode nÃ£o estar acessÃ­vel"
    fi
    
    # Teste backend
    if curl -s -f "http://nexodev.emasoftware.app/backend/public/status-nfe.php" > /dev/null; then
        log "âœ… Backend acessÃ­vel"
    else
        log "âš ï¸ Backend pode nÃ£o estar acessÃ­vel"
    fi
    
    # FinalizaÃ§Ã£o
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                âœ… DEPLOY DEV CONCLUÃDO                      â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "ğŸ¯ AMBIENTE DE DESENVOLVIMENTO:"
    echo "   â€¢ URL: http://nexodev.emasoftware.app"
    echo "   â€¢ Branch: dev"
    echo "   â€¢ Build: EstÃ¡tico otimizado"
    echo "   â€¢ Logs: $LOG_FILE"
    echo ""
    echo "ğŸ”§ COMANDOS ÃšTEIS:"
    echo "   â€¢ Rebuild: nexo-dev"
    echo "   â€¢ Logs Nginx: sudo tail -f /var/log/nginx/nexo-dev-error.log"
    echo "   â€¢ Status: sudo systemctl status nginx php8.3-fpm"
    echo ""
    echo "ğŸ“Š ENDPOINTS:"
    echo "   â€¢ Frontend: http://nexodev.emasoftware.app"
    echo "   â€¢ API Status: http://nexodev.emasoftware.app/backend/public/status-nfe.php"
    echo "   â€¢ Logs API: http://nexodev.emasoftware.app/backend/public/logs.php"
    echo ""
    echo "ğŸš€ Ambiente de desenvolvimento pronto!"
    echo ""
    
    log "ğŸ”¥ Deploy para DESENVOLVIMENTO concluÃ­do com sucesso"
}

# Executar funÃ§Ã£o principal
main "$@"
