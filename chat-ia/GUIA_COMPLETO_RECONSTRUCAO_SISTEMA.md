# üöÄ GUIA COMPLETO DE RECONSTRU√á√ÉO DO SISTEMA NEXO-PEDIDOS

## üìã √çNDICE
- [Vis√£o Geral do Sistema](#vis√£o-geral-do-sistema)
- [Leis Fundamentais](#leis-fundamentais)
- [Estrutura do Projeto](#estrutura-do-projeto)
- [Configura√ß√£o do Ambiente](#configura√ß√£o-do-ambiente)
- [Biblioteca sped-nfe](#biblioteca-sped-nfe)
- [Banco de Dados Supabase](#banco-de-dados-supabase)
- [Sistema de Certificados](#sistema-de-certificados)
- [Funcionalidades Implementadas](#funcionalidades-implementadas)
- [Debugging e Troubleshooting](#debugging-e-troubleshooting)

---

## üéØ VIS√ÉO GERAL DO SISTEMA

### **Arquitetura:**
- **Frontend:** React + TypeScript + Vite + Tailwind CSS
- **Backend:** PHP 7.4+ com sped-nfe v5.1.27
- **Banco:** Supabase (PostgreSQL)
- **Servidor:** Nginx + PHP-FPM
- **NFe/NFC-e:** Biblioteca sped-nfe (SAGRADA - N√ÉO MODIFICAR)

### **Funcionalidades Principais:**
- ‚úÖ **PDV Completo** com carrinho, clientes, produtos
- ‚úÖ **NFe Completa** (emiss√£o, cancelamento, CCe, inutiliza√ß√£o)
- ‚úÖ **NFC-e Implementada** (emiss√£o, numera√ß√£o sequencial, reprocessamento)
- ‚úÖ **Multi-tenant** (v√°rias empresas no mesmo sistema)
- ‚úÖ **Portal do Contador** (visualiza√ß√£o de documentos fiscais)
- ‚úÖ **Sistema de Email** (envio de NFe por email)

---

## ‚öñÔ∏è LEIS FUNDAMENTAIS (NUNCA VIOLAR)

### **LEI DOS DADOS REAIS**
- ‚ùå **NUNCA usar fallbacks** para testing
- ‚úÖ **SEMPRE usar dados reais** mesmo em homologa√ß√£o
- ‚úÖ **Buscar dados dinamicamente** de empresas e nfe_config

### **LEI DA BIBLIOTECA SAGRADA**
- ‚ùå **NUNCA modificar** a biblioteca sped-nfe
- ‚úÖ **Apenas ajustar** endpoints de comunica√ß√£o
- ‚úÖ **Biblioteca √© fiscalmente aprovada** - n√£o tocar

### **LEI DA AUTENTICIDADE**
- ‚ùå **NUNCA fazer simula√ß√µes**
- ‚úÖ **SEMPRE enviar dados reais** para homologa√ß√£o/produ√ß√£o
- ‚úÖ **Sem fallbacks** na implementa√ß√£o final

### **LEI DA EXCEL√äNCIA**
- ‚ùå **NUNCA usar workarounds** tempor√°rios
- ‚úÖ **SEMPRE encontrar** a solu√ß√£o correta
- ‚úÖ **Mesmo que demore mais** - fazer certo

### **LEI DA DOCUMENTA√á√ÉO OFICIAL**
- ‚úÖ **SEMPRE consultar** https://github.com/nfephp-org/sped-nfe/blob/master/docs/Make.md
- ‚úÖ **Documenta√ß√£o oficial** antes de implementar
- ‚úÖ **Seguir padr√µes** da biblioteca

---

## üìÅ ESTRUTURA DO PROJETO

```
nexo-pedidos/
‚îú‚îÄ‚îÄ src/                          # Frontend React
‚îÇ   ‚îú‚îÄ‚îÄ pages/dashboard/PDVPage.tsx  # PDV Principal
‚îÇ   ‚îú‚îÄ‚îÄ components/              # Componentes reutiliz√°veis
‚îÇ   ‚îî‚îÄ‚îÄ lib/supabase.ts         # Cliente Supabase
‚îú‚îÄ‚îÄ backend/                     # Backend PHP
‚îÇ   ‚îú‚îÄ‚îÄ public/                 # Endpoints p√∫blicos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ emitir-nfe.php     # Emiss√£o NFe
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ emitir-nfce.php    # Emiss√£o NFC-e
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cancelar-nfe.php   # Cancelamento
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cce-nfe.php        # Carta de Corre√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ src/                   # Classes PHP
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NFEService.php     # Servi√ßo principal NFe
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SupabaseService.php # Cliente Supabase PHP
‚îÇ   ‚îú‚îÄ‚îÄ storage/               # Armazenamento local
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ certificados/      # Certificados .pfx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ xml/              # XMLs gerados
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pdf/              # PDFs gerados
‚îÇ   ‚îî‚îÄ‚îÄ composer.json         # Depend√™ncias PHP
‚îú‚îÄ‚îÄ chat-ia/                  # Documenta√ß√£o para IAs
‚îú‚îÄ‚îÄ Doc/                      # Documenta√ß√£o geral
‚îú‚îÄ‚îÄ .env.example             # Template vari√°veis
‚îú‚îÄ‚îÄ install.sh              # Script instala√ß√£o
‚îî‚îÄ‚îÄ nginx.conf             # Configura√ß√£o Nginx
```

---

## ‚öôÔ∏è CONFIGURA√á√ÉO DO AMBIENTE

### **1. Vari√°veis de Ambiente (.env):**
```env
# Supabase
VITE_SUPABASE_URL=https://xsrirnfwsjeovekwtluz.supabase.co
VITE_SUPABASE_ANON_KEY=sua_chave_anonima

# Email (Gmail SMTP)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=seu_email@gmail.com
SMTP_PASSWORD=sua_senha_app
SMTP_FROM_EMAIL=seu_email@gmail.com
SMTP_FROM_NAME="Nexo Sistemas"
```

### **2. Instala√ß√£o Automatizada:**
```bash
git clone https://github.com/emanuelsistemas/nexo-pedidos.git
cd nexo-pedidos
chmod +x install.sh
./install.sh
```

### **3. Depend√™ncias Cr√≠ticas:**
```bash
# PHP Extensions (OBRIGAT√ìRIAS)
php7.4-fpm php7.4-cli php7.4-xml php7.4-mbstring 
php7.4-curl php7.4-zip php7.4-gd php7.4-json php7.4-soap

# Composer (sped-nfe)
composer install

# Node.js (Frontend)
npm install
npm run build
```

---

## üìö BIBLIOTECA SPED-NFE

### **Vers√£o Exata:** v5.1.27
```json
{
    "require": {
        "nfephp-org/sped-nfe": "^5.1.27"
    }
}
```

### **Configura√ß√£o Cr√≠tica:**
```php
// NUNCA MODIFICAR - Configura√ß√£o sagrada
$config = [
    "atualizacao" => date('Y-m-d H:i:s'),
    "tpAmb" => $ambiente, // 1=Produ√ß√£o, 2=Homologa√ß√£o
    "razaosocial" => $empresa['razao_social'],
    "cnpj" => $empresa['documento'],
    "ie" => $empresa['inscricao_estadual'],
    "siglaUF" => $empresa['estado'],
    "schemes" => "PL_009_V4",
    "versao" => "4.00",
    "tokenIBPT" => "",
    "CSC" => $csc,
    "CSCid" => $csc_id
];
```

### **Endpoints SEFAZ (N√ÉO MODIFICAR):**
- **Homologa√ß√£o:** URLs autom√°ticas da biblioteca
- **Produ√ß√£o:** URLs autom√°ticas da biblioteca
- **Biblioteca gerencia** todos os endpoints

### **Estrutura de Armazenamento:**
```
storage/
‚îú‚îÄ‚îÄ certificados/empresa_id/certificado.pfx
‚îú‚îÄ‚îÄ xml/empresa_id/{homologacao,producao}/{55,65}/{ano}/{mes}/
‚îÇ   ‚îú‚îÄ‚îÄ Autorizados/
‚îÇ   ‚îî‚îÄ‚îÄ Cancelados/
‚îî‚îÄ‚îÄ pdf/empresa_id/{homologacao,producao}/{55,65}/{ano}/{mes}/
    ‚îú‚îÄ‚îÄ Autorizados/
    ‚îî‚îÄ‚îÄ CCe/
```

---

## üóÑÔ∏è BANCO DE DADOS SUPABASE

### **Projeto:** nexo (ID: xsrirnfwsjeovekwtluz)
### **Regi√£o:** sa-east-1

### **Tabelas Principais:**

#### **empresas**
```sql
CREATE TABLE empresas (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    razao_social TEXT NOT NULL,
    nome_fantasia TEXT,
    documento TEXT NOT NULL, -- CNPJ
    inscricao_estadual TEXT,
    regime_tributario INTEGER DEFAULT 1,
    endereco TEXT,
    numero TEXT,
    bairro TEXT,
    cidade TEXT,
    estado TEXT,
    cep TEXT,
    codigo_municipio TEXT,
    csc_homologacao TEXT,
    csc_id_homologacao INTEGER,
    csc_producao TEXT,
    csc_id_producao INTEGER,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### **nfe_config**
```sql
CREATE TABLE nfe_config (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    empresa_id UUID REFERENCES empresas(id),
    ambiente INTEGER DEFAULT 2, -- 1=Produ√ß√£o, 2=Homologa√ß√£o
    serie_nfe INTEGER DEFAULT 1,
    serie_nfce INTEGER DEFAULT 1,
    ultimo_numero_nfe INTEGER DEFAULT 0,
    ultimo_numero_nfce INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### **pdv (Vendas)**
```sql
CREATE TABLE pdv (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    empresa_id UUID REFERENCES empresas(id),
    usuario_id UUID,
    numero_venda TEXT NOT NULL,
    data_venda TIMESTAMP DEFAULT NOW(),
    status_venda TEXT DEFAULT 'finalizada',
    valor_subtotal DECIMAL(10,2),
    valor_desconto DECIMAL(10,2) DEFAULT 0,
    valor_total DECIMAL(10,2),

    -- Campos Fiscais
    modelo_documento INTEGER DEFAULT 65, -- 55=NFe, 65=NFC-e
    numero_documento INTEGER, -- N√∫mero fiscal sequencial
    serie_documento INTEGER DEFAULT 1,
    chave_nfe TEXT,
    protocolo_nfe TEXT,
    xml_path TEXT,
    pdf_path TEXT,
    status_fiscal TEXT DEFAULT 'nao_fiscal', -- 'nao_fiscal', 'processando', 'autorizada', 'pendente'
    tentativa_nfce BOOLEAN DEFAULT FALSE,
    erro_fiscal TEXT,
    data_autorizacao TIMESTAMP,

    -- Cliente
    nome_cliente TEXT,
    documento_cliente TEXT,

    created_at TIMESTAMP DEFAULT NOW()
);
```

#### **pdv_itens**
```sql
CREATE TABLE pdv_itens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    pdv_id UUID REFERENCES pdv(id),
    produto_id UUID REFERENCES produtos(id),
    nome_produto TEXT NOT NULL,
    codigo_produto TEXT,
    quantidade DECIMAL(10,3),
    valor_unitario DECIMAL(10,2),
    valor_total DECIMAL(10,2),

    -- Campos Fiscais
    cfop TEXT DEFAULT '5102',
    cst_icms TEXT,
    csosn TEXT,

    created_at TIMESTAMP DEFAULT NOW()
);
```

#### **cce_nfe (Carta de Corre√ß√£o)**
```sql
CREATE TABLE cce_nfe (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    empresa_id UUID REFERENCES empresas(id),
    chave_nfe TEXT NOT NULL,
    sequencia INTEGER DEFAULT 1,
    correcao TEXT NOT NULL,
    protocolo TEXT,
    xml_path TEXT,
    pdf_path TEXT,
    data_evento TIMESTAMP DEFAULT NOW(),
    created_at TIMESTAMP DEFAULT NOW()
);
```

### **RLS (Row Level Security):**
```sql
-- Empresas: usu√°rio s√≥ v√™ sua empresa
ALTER TABLE empresas ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view own company" ON empresas
    FOR ALL USING (id = (SELECT empresa_id FROM usuarios WHERE id = auth.uid()));

-- PDV: usu√°rio s√≥ v√™ vendas da sua empresa
ALTER TABLE pdv ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view own company sales" ON pdv
    FOR ALL USING (empresa_id = (SELECT empresa_id FROM usuarios WHERE id = auth.uid()));
```

---

## üîê SISTEMA DE CERTIFICADOS

### **Estrutura de Armazenamento:**
```
backend/storage/certificados/
‚îî‚îÄ‚îÄ {empresa_id}/
    ‚îú‚îÄ‚îÄ certificado.pfx
    ‚îî‚îÄ‚îÄ senha.txt (opcional)
```

### **Configura√ß√£o de Seguran√ßa:**
```bash
# Permiss√µes cr√≠ticas
sudo chmod -R 700 backend/storage/certificados/
sudo chown -R www-data:www-data backend/storage/certificados/
```

### **Valida√ß√£o de Certificado:**
```php
// Verificar se certificado existe e √© v√°lido
$certificadoPath = "/caminho/storage/certificados/{$empresaId}/certificado.pfx";
if (!file_exists($certificadoPath)) {
    throw new Exception("Certificado n√£o encontrado para empresa {$empresaId}");
}

// Validar certificado
$certificadoContent = file_get_contents($certificadoPath);
if (!openssl_pkcs12_read($certificadoContent, $certs, $senha)) {
    throw new Exception("Certificado inv√°lido ou senha incorreta");
}
```

---

## üéØ FUNCIONALIDADES IMPLEMENTADAS

### **PDV (Ponto de Venda):**
- ‚úÖ **Carrinho de compras** com produtos
- ‚úÖ **Clientes** (CPF/CNPJ na nota)
- ‚úÖ **Descontos** por item e por prazo
- ‚úÖ **Importa√ß√£o de pedidos**
- ‚úÖ **Finaliza√ß√£o m√∫ltipla** (sem impress√£o, NFe, NFC-e)

### **NFC-e (Nota Fiscal do Consumidor Eletr√¥nica):**
- ‚úÖ **Numera√ß√£o sequencial** garantida
- ‚úÖ **Emiss√£o autom√°tica** no PDV
- ‚úÖ **Reprocessamento** de NFC-e com erro
- ‚úÖ **Edi√ß√£o de campos fiscais** (CFOP, CST, CSOSN)
- ‚úÖ **Edi√ß√£o de numera√ß√£o** para corre√ß√£o de duplicatas
- ‚úÖ **Tags visuais** na listagem (NFC-e #123, Pendente, Autorizada)

### **NFe (Nota Fiscal Eletr√¥nica):**
- ‚úÖ **Emiss√£o completa** com todos os campos
- ‚úÖ **Cancelamento** com justificativa
- ‚úÖ **CCe** (Carta de Corre√ß√£o Eletr√¥nica)
- ‚úÖ **Inutiliza√ß√£o** de numera√ß√£o
- ‚úÖ **Email autom√°tico** com PDF e XML

### **Portal do Contador:**
- ‚úÖ **Visualiza√ß√£o** de NFe/NFC-e por empresa
- ‚úÖ **Download** de XMLs e PDFs
- ‚úÖ **Filtros** por per√≠odo e tipo
- ‚úÖ **Apenas produ√ß√£o** (n√£o mostra homologa√ß√£o)

---

## üîß DEBUGGING E TROUBLESHOOTING

### **Logs Importantes:**
```bash
# Logs Nginx
sudo tail -f /var/log/nginx/error.log

# Logs PHP-FPM
sudo tail -f /var/log/php7.4-fpm.log

# Logs do Sistema (custom)
curl "http://localhost/backend/public/logs.php?level=error&limit=10"
```

### **T√©cnicas de Debug:**

#### **1. Payload Search (Busca por Payload):**
```javascript
// No console do navegador
console.log('üîç PAYLOAD ENVIADO:', JSON.stringify(payload, null, 2));

// No PHP
error_log('üîç PAYLOAD RECEBIDO: ' . json_encode($payload, JSON_PRETTY_PRINT));
```

#### **2. Valida√ß√£o de Dados:**
```php
// Sempre validar dados antes de usar
if (empty($empresa['documento'])) {
    throw new Exception('CNPJ da empresa n√£o encontrado');
}

if (empty($nfeConfig['ambiente'])) {
    throw new Exception('Ambiente NFe n√£o configurado');
}
```

#### **3. Verifica√ß√£o de Certificados:**
```php
// Verificar certificado antes de usar
$certificadoPath = $this->getCertificadoPath($empresaId);
if (!file_exists($certificadoPath)) {
    throw new Exception("Certificado n√£o encontrado: {$certificadoPath}");
}
```

### **Problemas Comuns e Solu√ß√µes:**

#### **‚ùå Erro: "Certificado n√£o encontrado"**
```bash
# Verificar estrutura
ls -la backend/storage/certificados/
# Verificar permiss√µes
sudo chown -R www-data:www-data backend/storage/
```

#### **‚ùå Erro: "Ambiente n√£o encontrado"**
```sql
-- Verificar configura√ß√£o
SELECT * FROM nfe_config WHERE empresa_id = 'uuid-da-empresa';
-- Inserir se n√£o existir
INSERT INTO nfe_config (empresa_id, ambiente) VALUES ('uuid', 2);
```

#### **‚ùå Erro: "Numera√ß√£o duplicada"**
```sql
-- Verificar √∫ltimo n√∫mero
SELECT MAX(numero_documento) FROM pdv WHERE empresa_id = 'uuid' AND modelo_documento = 65;
-- Usar modal de edi√ß√£o para corrigir n√∫mero
```

#### **‚ùå Erro: "sped-nfe n√£o encontrado"**
```bash
# Reinstalar depend√™ncias
cd backend
composer install
# Verificar autoload
composer dump-autoload
```

---

## üìù IMPLEMENTA√á√ïES ESPEC√çFICAS

### **Numera√ß√£o Sequencial NFC-e:**
```typescript
// 1. Reservar n√∫mero ANTES de salvar venda
const numeroReservado = await gerarProximoNumeroNFCe(empresaId);

// 2. Salvar venda com n√∫mero j√° definido
const vendaData = {
    numero_documento: numeroReservado,
    modelo_documento: 65,
    status_fiscal: 'processando'
};

// 3. Validar n√∫mero durante processamento
const { data: vendaSalva } = await supabase
    .from('pdv')
    .select('numero_documento')
    .eq('id', vendaId)
    .single();

if (!vendaSalva.numero_documento) {
    throw new Error('N√∫mero NFC-e n√£o foi reservado');
}
```

### **Fluxo de Erro NFC-e:**
```typescript
// Quando h√° erro na NFC-e:
try {
    // Tentar emitir NFC-e
    const result = await emitirNfce(payload);
} catch (error) {
    // 1. Salvar erro no banco
    await supabase.from('pdv').update({
        status_fiscal: 'pendente',
        erro_fiscal: error.message
    }).eq('id', vendaId);

    // 2. Limpar carrinho silenciosamente
    setCarrinho([]);
    // ... outros resets

    // 3. Mostrar modal de erro (n√£o interromper fluxo)
    setErroProcessamento(error.message);

    // 4. Usu√°rio resolve depois em Movimentos > Editar NFC-e
}
```

### **Tags Visuais na Listagem:**
```typescript
// Tag NFC-e com n√∫mero
{venda.tentativa_nfce && (
    <span className="px-2 py-1 bg-purple-500/20 text-purple-400 text-xs font-medium rounded-full">
        {venda.numero_documento ? `NFC-e #${venda.numero_documento}` : 'NFC-e'}
    </span>
)}

// Tag de status
{venda.status_fiscal === 'pendente' && (
    <span className="px-2 py-1 bg-yellow-500/20 text-yellow-400 text-xs font-medium rounded-full">
        Pendente
    </span>
)}
```

---

## üéØ CHECKLIST DE RECONSTRU√á√ÉO

### **‚úÖ Ambiente:**
- [ ] Node.js 18+ instalado
- [ ] PHP 7.4+ com extens√µes
- [ ] Nginx configurado
- [ ] Composer instalado

### **‚úÖ C√≥digo:**
- [ ] Reposit√≥rio clonado
- [ ] npm install executado
- [ ] composer install executado
- [ ] npm run build executado

### **‚úÖ Configura√ß√£o:**
- [ ] .env configurado
- [ ] Nginx configurado
- [ ] Permiss√µes definidas
- [ ] Supabase conectado

### **‚úÖ Banco de Dados:**
- [ ] Tabelas criadas
- [ ] RLS configurado
- [ ] Dados iniciais inseridos

### **‚úÖ Certificados:**
- [ ] Diret√≥rio criado
- [ ] Certificados copiados
- [ ] Permiss√µes 700 definidas

### **‚úÖ Testes:**
- [ ] Frontend carregando
- [ ] Backend respondendo
- [ ] Login funcionando
- [ ] NFe/NFC-e funcionando

---

## üö® AVISOS CR√çTICOS

### **‚ö†Ô∏è NUNCA FAZER:**
- ‚ùå Modificar biblioteca sped-nfe
- ‚ùå Usar dados fake em produ√ß√£o
- ‚ùå Ignorar erros de certificado
- ‚ùå Pular valida√ß√µes de dados
- ‚ùå Usar workarounds tempor√°rios

### **‚úÖ SEMPRE FAZER:**
- ‚úÖ Consultar documenta√ß√£o oficial
- ‚úÖ Validar dados antes de usar
- ‚úÖ Logar erros detalhadamente
- ‚úÖ Testar em homologa√ß√£o primeiro
- ‚úÖ Seguir as leis fundamentais

---

## üìû SUPORTE E CONTATO

- **Email:** nexo@emanuelsistemas.com
- **GitHub:** https://github.com/emanuelsistemas/nexo-pedidos
- **Documenta√ß√£o sped-nfe:** https://github.com/nfephp-org/sped-nfe

---

**üéØ Este guia garante que qualquer IA possa reconstruir o sistema completo sem perder funcionalidades ou violar as leis fundamentais do projeto.**
