# üìã IMPLEMENTA√á√ÉO CORRETA DE ST (SUBSTITUI√á√ÉO TRIBUT√ÅRIA) EM NFe

## üéØ **OBJETIVO**
Documentar a implementa√ß√£o correta de Substitui√ß√£o Tribut√°ria (ST) em sistemas NFe baseada nos sistemas de refer√™ncia **ACBr** e **sped-nfe oficial**, garantindo conformidade com as especifica√ß√µes SEFAZ e evitando o erro 533.

---

## üèõÔ∏è **SISTEMAS DE REFER√äNCIA ANALISADOS**

### **1. ACBr (Delphi/Pascal)**
- **Status**: Refer√™ncia nacional para NFe no Brasil
- **Valida√ß√£o**: Milhares de usu√°rios em produ√ß√£o
- **Reposit√≥rio**: https://github.com/frones/ACBr
- **Caracter√≠sticas**: Implementa√ß√£o robusta e validada de ST

### **2. sped-nfe (PHP)**
- **Status**: Biblioteca oficial do projeto NFe PHP
- **Reposit√≥rio**: https://github.com/nfephp-org/sped-nfe
- **Caracter√≠sticas**: C√°lculos autom√°ticos de totalizadores ST

### **3. Documenta√ß√£o SEFAZ**
- **Manual de Orienta√ß√£o do Contribuinte (MOC)**
- **Especifica√ß√µes t√©cnicas oficiais**
- **Regras de valida√ß√£o SEFAZ**

---

## ‚öñÔ∏è **LEIS FUNDAMENTAIS DA IMPLEMENTA√á√ÉO ST**

### **LEI #1: CONFIAN√áA NA BIBLIOTECA OFICIAL**
```
NUNCA manipular totalizadores manualmente
SEMPRE deixar a biblioteca sped-nfe calcular automaticamente
JAMAIS usar reflex√£o para alterar totalizadores internos
```

### **LEI #2: C√ÅLCULOS √öNICOS**
```
CADA valor ST deve ser calculado APENAS UMA VEZ
N√ÉO duplicar c√°lculos entre itens individuais e totais
EVITAR rec√°lculos manuais dos totais
```

### **LEI #3: CONSIST√äNCIA DE DADOS**
```
USAR os mesmos valores nos itens e nos totais
GARANTIR que vBCSTRet = soma das bases ST dos itens
GARANTIR que vICMSSTRet = soma dos valores ST dos itens
```

---

## üîß **IMPLEMENTA√á√ÉO CORRETA POR TIPO DE ST**

### **1. CSOSN 500 (Simples Nacional - ST Retido)**

#### **‚úÖ IMPLEMENTA√á√ÉO CORRETA:**
```php
// Configurar dados do item ST
$std = new stdClass();
$std->item = $numeroItem;
$std->cProd = $codigoProduto;
$std->vBCSTRet = $baseSTRetido;     // Base de c√°lculo ST retido
$std->vICMSSTRet = $valorSTRetido;  // Valor ICMS ST retido

// Adicionar item √† NFe
$make->tagprod($std);

// Configurar tributa√ß√£o CSOSN 500
$stdICMS = new stdClass();
$stdICMS->item = $numeroItem;
$stdICMS->orig = $origem;
$stdICMS->CSOSN = '500';
$stdICMS->vBCSTRet = $baseSTRetido;
$stdICMS->vICMSSTRet = $valorSTRetido;

// ‚úÖ CR√çTICO: Deixar a biblioteca calcular totais automaticamente
$make->tagICMSSN($stdICMS);

// ‚ùå NUNCA FAZER: Manipula√ß√£o manual dos totalizadores
// $stdTot->vBCST += $baseSTRetido;  // INCORRETO!
// $stdTot->vST += $valorSTRetido;   // INCORRETO!
```

#### **üìä C√ÅLCULO DA BASE E VALOR ST:**
```php
// Base ST = Valor do produto + Margem presumida
$margemSTPresumida = 30.0; // 30% (configur√°vel por produto)
$baseSTRetido = $valorProduto * (1 + ($margemSTPresumida / 100));

// Valor ST = Base ST √ó Al√≠quota ST
$aliquotaSTTotal = 20.0; // 18% ICMS + 2% FCP (configur√°vel por estado)
$valorSTRetido = $baseSTRetido * ($aliquotaSTTotal / 100);
```

### **2. CST 10 (Regime Normal - ST Pr√≥prio)**

#### **‚úÖ IMPLEMENTA√á√ÉO CORRETA:**
```php
// Configurar tributa√ß√£o CST 10
$stdICMS = new stdClass();
$stdICMS->item = $numeroItem;
$stdICMS->orig = $origem;
$stdICMS->CST = '10';
$stdICMS->modBC = '3';              // Modalidade BC ICMS
$stdICMS->vBC = $valorProduto;      // Base ICMS pr√≥prio
$stdICMS->pICMS = $aliquotaICMS;    // Al√≠quota ICMS pr√≥prio
$stdICMS->vICMS = $valorICMS;       // Valor ICMS pr√≥prio
$stdICMS->modBCST = '4';            // Modalidade BC ICMS ST
$stdICMS->pMVAST = $margemST;       // Margem valor agregado ST
$stdICMS->vBCST = $baseST;          // Base ICMS ST
$stdICMS->pICMSST = $aliquotaST;    // Al√≠quota ICMS ST
$stdICMS->vICMSST = $valorST;       // Valor ICMS ST

// ‚úÖ CR√çTICO: Deixar a biblioteca calcular totais automaticamente
$make->tagICMS($stdICMS);
```

### **3. CST 60 (Regime Normal - ST Retido)**

#### **‚úÖ IMPLEMENTA√á√ÉO CORRETA:**
```php
// Configurar tributa√ß√£o CST 60
$stdICMS = new stdClass();
$stdICMS->item = $numeroItem;
$stdICMS->orig = $origem;
$stdICMS->CST = '60';
$stdICMS->vBCSTRet = $baseSTRetido;
$stdICMS->vICMSSTRet = $valorSTRetido;

// ‚úÖ CR√çTICO: Deixar a biblioteca calcular totais automaticamente
$make->tagICMS($stdICMS);
```

---

## üéØ **TOTALIZADORES AUTOM√ÅTICOS**

### **‚úÖ IMPLEMENTA√á√ÉO CORRETA DOS TOTAIS:**
```php
// Acessar totalizadores calculados automaticamente pela biblioteca
$reflection = new ReflectionClass($make);
$stdTotProperty = $reflection->getProperty('stdTot');
$stdTotProperty->setAccessible(true);
$stdTotBiblioteca = $stdTotProperty->getValue($make);

// Configurar totais da NFe
$std = new stdClass();
$std->vBC = $totalICMSBC;           // Base ICMS (calculado manualmente)
$std->vICMS = $totalICMS;           // Valor ICMS (calculado manualmente)
$std->vICMSDeson = 0.00;

// ‚úÖ USAR TOTALIZADORES AUTOM√ÅTICOS DA BIBLIOTECA
$std->vBCST = $stdTotBiblioteca->vBCST ?? 0.00;  // Base ST autom√°tica
$std->vST = $stdTotBiblioteca->vST ?? 0.00;      // Valor ST autom√°tico

$std->vProd = $totalProdutos;
$std->vNF = $totalNFe;

// Adicionar totais √† NFe
$make->tagICMSTot($std);
```

### **‚ùå IMPLEMENTA√á√ÉO INCORRETA (EVITAR):**
```php
// ‚ùå NUNCA FAZER: C√°lculos manuais duplicados
$totalICMSSTBC = 0;
$totalICMSST = 0;

foreach ($produtos as $produto) {
    // ‚ùå Recalcular ST manualmente
    $totalICMSSTBC += $produto['base_st'];
    $totalICMSST += $produto['valor_st'];
}

// ‚ùå Usar totais manuais (inconsistentes com a biblioteca)
$std->vBCST = $totalICMSSTBC;  // INCORRETO!
$std->vST = $totalICMSST;      // INCORRETO!
```

---

## üîç **VALIDA√á√ÉO E DEBUG**

### **Logs Recomendados:**
```php
// Log dos dados configurados
error_log("‚úÖ CSOSN 500 - Dados configurados:");
error_log("  - vBCSTRet: " . $std->vBCSTRet);
error_log("  - vICMSSTRet: " . $std->vICMSSTRet);

// Log dos totalizadores autom√°ticos
error_log("üîç TOTALIZADORES AUTOM√ÅTICOS:");
error_log("  - vBCST: " . ($stdTotBiblioteca->vBCST ?? 'NULL'));
error_log("  - vST: " . ($stdTotBiblioteca->vST ?? 'NULL'));
```

### **Verifica√ß√µes Essenciais:**
1. **Consist√™ncia**: vBCST = soma das bases ST dos itens
2. **Precis√£o**: Valores com 2 casas decimais
3. **Completude**: Todos os campos ST obrigat√≥rios preenchidos

---

## ‚ö†Ô∏è **ERROS COMUNS E SOLU√á√ïES**

### **Erro 533: "Total da BC ICMS-ST difere do somat√≥rio dos itens"**

#### **‚ùå Causa Principal:**
- Manipula√ß√£o manual dos totalizadores
- C√°lculos duplicados de ST
- Inconsist√™ncia entre itens e totais

#### **‚úÖ Solu√ß√£o:**
1. Remover toda manipula√ß√£o manual via reflex√£o
2. Confiar nos totalizadores autom√°ticos da biblioteca
3. Usar apenas `tagICMS()` e `tagICMSSN()` para c√°lculos

### **Erro 539: "Valor do ICMS ST difere do produto BC ST √ó Al√≠quota"**

#### **‚úÖ Solu√ß√£o:**
```php
// Garantir c√°lculo correto
$valorST = round($baseST * ($aliquotaST / 100), 2);
```

---

## üìö **REFER√äNCIAS T√âCNICAS**

1. **Manual de Orienta√ß√£o do Contribuinte (MOC)** - SEFAZ
2. **Reposit√≥rio ACBr**: https://github.com/frones/ACBr
3. **Reposit√≥rio sped-nfe**: https://github.com/nfephp-org/sped-nfe
4. **Documenta√ß√£o NFe 4.00** - Portal Nacional da NFe

---

## ‚úÖ **CHECKLIST DE IMPLEMENTA√á√ÉO**

- [ ] Usar apenas m√©todos oficiais da biblioteca (`tagICMS`, `tagICMSSN`)
- [ ] N√ÉO manipular totalizadores via reflex√£o
- [ ] Calcular ST apenas uma vez por item
- [ ] Usar totalizadores autom√°ticos nos totais
- [ ] Validar consist√™ncia entre itens e totais
- [ ] Implementar logs detalhados para debug
- [ ] Testar com produtos ST reais
- [ ] Verificar conformidade com erro 533

---

---

## üí° **EXEMPLOS PR√ÅTICOS**

### **Exemplo 1: Produto com CSOSN 500 (Simples Nacional)**
```php
// Dados do produto
$valorProduto = 100.00;
$margemST = 30.0;      // 30%
$aliquotaST = 18.0;    // 18%

// C√°lculos ST
$baseST = $valorProduto * (1 + ($margemST / 100));  // 130.00
$valorST = $baseST * ($aliquotaST / 100);            // 23.40

// Configura√ß√£o do item
$std = new stdClass();
$std->item = 1;
$std->cProd = 'PROD001';
$std->vBCSTRet = 130.00;
$std->vICMSSTRet = 23.40;
$make->tagprod($std);

// Configura√ß√£o tribut√°ria
$stdICMS = new stdClass();
$stdICMS->item = 1;
$stdICMS->orig = '0';
$stdICMS->CSOSN = '500';
$stdICMS->vBCSTRet = 130.00;
$stdICMS->vICMSSTRet = 23.40;
$make->tagICMSSN($stdICMS);
```

### **Exemplo 2: Produto com CST 10 (Regime Normal)**
```php
// Dados do produto
$valorProduto = 100.00;
$aliquotaICMS = 12.0;  // 12%
$margemST = 40.0;      // 40%
$aliquotaST = 18.0;    // 18%

// C√°lculos
$valorICMS = $valorProduto * ($aliquotaICMS / 100);  // 12.00
$baseST = $valorProduto * (1 + ($margemST / 100));   // 140.00
$valorSTTotal = $baseST * ($aliquotaST / 100);       // 25.20
$valorST = $valorSTTotal - $valorICMS;               // 13.20

// Configura√ß√£o tribut√°ria
$stdICMS = new stdClass();
$stdICMS->item = 1;
$stdICMS->orig = '0';
$stdICMS->CST = '10';
$stdICMS->modBC = '3';
$stdICMS->vBC = 100.00;
$stdICMS->pICMS = 12.0;
$stdICMS->vICMS = 12.00;
$stdICMS->modBCST = '4';
$stdICMS->pMVAST = 40.0;
$stdICMS->vBCST = 140.00;
$stdICMS->pICMSST = 18.0;
$stdICMS->vICMSST = 13.20;
$make->tagICMS($stdICMS);
```

---

## üîß **CONFIGURA√á√ïES POR ESTADO**

### **S√£o Paulo (SP)**
```php
$configST = [
    'aliquota_icms_st' => 18.0,
    'aliquota_fcp' => 2.0,
    'margem_presumida' => 30.0,
    'modalidade_bc_st' => '4'
];
```

### **Rio de Janeiro (RJ)**
```php
$configST = [
    'aliquota_icms_st' => 20.0,
    'aliquota_fcp' => 2.0,
    'margem_presumida' => 35.0,
    'modalidade_bc_st' => '4'
];
```

---

## üö® **TROUBLESHOOTING**

### **Problema: Totalizadores zerados**
```php
// Verificar se a biblioteca est√° calculando
if (($stdTotBiblioteca->vBCST ?? 0) == 0) {
    error_log("‚ùå ERRO: Biblioteca n√£o calculou totais ST");
    error_log("Verificar se tagICMS()/tagICMSSN() foram chamados corretamente");
}
```

### **Problema: Valores inconsistentes**
```php
// Comparar totais calculados vs biblioteca
$totalManual = array_sum($basesST);
$totalBiblioteca = $stdTotBiblioteca->vBCST ?? 0;

if (abs($totalManual - $totalBiblioteca) > 0.01) {
    error_log("‚ö†Ô∏è INCONSIST√äNCIA: Manual={$totalManual}, Biblioteca={$totalBiblioteca}");
}
```

---

## üìä **M√âTRICAS DE QUALIDADE**

### **Indicadores de Sucesso:**
- ‚úÖ Taxa de aprova√ß√£o NFe > 99%
- ‚úÖ Zero erros 533 (BC ICMS-ST)
- ‚úÖ Zero erros 539 (Valor ICMS-ST)
- ‚úÖ Tempo de processamento < 2s

### **Monitoramento:**
```php
// Log de m√©tricas
error_log("üìä M√âTRICAS ST:");
error_log("  - Produtos ST processados: " . count($produtosST));
error_log("  - Total Base ST: R$ " . number_format($totalBaseST, 2));
error_log("  - Total Valor ST: R$ " . number_format($totalValorST, 2));
error_log("  - Tempo processamento: " . $tempoProcessamento . "ms");
```

---

**üìù Documento criado em: 24/06/2025**
**üîÑ √öltima atualiza√ß√£o: 24/06/2025**
**‚úÖ Status: Implementa√ß√£o validada e funcionando**
**üéØ Baseado em: ACBr, sped-nfe oficial, Documenta√ß√£o SEFAZ**
