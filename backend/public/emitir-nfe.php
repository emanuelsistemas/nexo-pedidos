<?php
// ‚úÖ CONFIGURAR TIMEZONE BRASILEIRO PARA CORRIGIR HOR√ÅRIO
date_default_timezone_set('America/Sao_Paulo');

// ‚úÖ DEBUG: Configurar logs de erro
error_reporting(E_ALL);
ini_set('display_errors', 0); // ‚úÖ DESABILITAR display_errors para evitar HTML no JSON
ini_set('log_errors', 1);
ini_set('error_log', '/var/log/php_nfe_debug.log');

// ‚úÖ FUN√á√ÉO DE LOG DETALHADO (igual √† NFC-e)
function logDetalhado($step, $message, $data = []) {
    $timestamp = date('Y-m-d H:i:s');
    $logEntry = "[{$timestamp}] [{$step}] {$message}";

    if (!empty($data)) {
        $logEntry .= " | DATA: " . json_encode($data, JSON_UNESCAPED_UNICODE);
    }

    error_log($logEntry);

    // Salvar tamb√©m em arquivo espec√≠fico para debug
    $debugFile = '/tmp/nfe_detailed.log';
    file_put_contents($debugFile, $logEntry . "\n", FILE_APPEND | LOCK_EX);
}

// ‚úÖ DEBUG CR√çTICO: Registrar handler de erro fatal para capturar HTTP 502
register_shutdown_function(function() {
    $error = error_get_last();
    if ($error && in_array($error['type'], [E_ERROR, E_PARSE, E_CORE_ERROR, E_COMPILE_ERROR, E_USER_ERROR])) {
        $errorMsg = "‚ùå ERRO FATAL NFe: " . $error['message'] . " em " . $error['file'] . ":" . $error['line'];
        error_log($errorMsg);

        // Salvar em arquivo espec√≠fico para debug
        file_put_contents('/tmp/nfe_fatal_error.log', date('Y-m-d H:i:s') . " - " . $errorMsg . "\n", FILE_APPEND);

        // Tentar enviar resposta JSON mesmo com erro fatal
        if (!headers_sent()) {
            header('Content-Type: application/json; charset=utf-8');
            http_response_code(500);
            echo json_encode([
                'success' => false,
                'error' => 'Erro fatal no servidor: ' . $error['message'],
                'error_type' => 'fatal_error',
                'debug_info' => [
                    'file' => basename($error['file']),
                    'line' => $error['line'],
                    'type' => $error['type'],
                    'step' => 'FATAL_ERROR'
                ]
            ]);
        }
    }
});

// ‚úÖ CONFIGURA√á√ÉO DE TIMEOUT PARA EVITAR 502
ini_set('max_execution_time', 300); // 5 minutos
ini_set('memory_limit', '512M');

header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type');

// Handle preflight requests
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    exit(0);
}

// ‚úÖ DEBUG: Log in√≠cio da execu√ß√£o
error_log("=== IN√çCIO EMISS√ÉO NFE === " . date('Y-m-d H:i:s'));
error_log("REQUEST_METHOD: " . $_SERVER['REQUEST_METHOD']);
error_log("CONTENT_TYPE: " . ($_SERVER['CONTENT_TYPE'] ?? 'N/A'));

require_once '../vendor/autoload.php';

// TRADUZIR ERROS SEFAZ PARA MENSAGENS AMIG√ÅVEIS
function traduzirErroSefaz($status, $motivo) {
    $errosComuns = [
        // Erros de Duplicidade e Numera√ß√£o
        '206' => [
            'titulo' => 'NFe Duplicada',
            'descricao' => 'Esta NFe j√° foi inutilizada na SEFAZ e n√£o pode ser emitida.',
            'solucao' => 'Use um n√∫mero diferente ou verifique se a numera√ß√£o n√£o foi inutilizada.'
        ],
        '539' => [
            'titulo' => 'NFe Duplicada',
            'descricao' => 'J√° existe uma NFe autorizada com este n√∫mero e s√©rie.',
            'solucao' => 'Use um n√∫mero sequencial diferente para esta NFe.'
        ],

        // Erros de Documentos
        '204' => [
            'titulo' => 'CNPJ Inv√°lido',
            'descricao' => 'O CNPJ da empresa est√° incorreto ou inv√°lido.',
            'solucao' => 'Verifique e corrija o CNPJ da empresa nas configura√ß√µes.'
        ],
        '207' => [
            'titulo' => 'CNPJ Inv√°lido',
            'descricao' => 'O CNPJ do emitente est√° incorreto ou inv√°lido.',
            'solucao' => 'Verifique e corrija o CNPJ da empresa nas configura√ß√µes.'
        ],
        '209' => [
            'titulo' => 'Inscri√ß√£o Estadual Inv√°lida',
            'descricao' => 'A Inscri√ß√£o Estadual da empresa est√° incorreta ou inv√°lida.',
            'solucao' => 'Verifique e corrija a Inscri√ß√£o Estadual da empresa nas configura√ß√µes.'
        ],
        '215' => [
            'titulo' => 'CNPJ do Destinat√°rio Inv√°lido',
            'descricao' => 'O CNPJ/CPF do destinat√°rio est√° incorreto.',
            'solucao' => 'Verifique e corrija o documento do destinat√°rio.'
        ],
        '401' => [
            'titulo' => 'CPF Inv√°lido',
            'descricao' => 'O CPF do emitente est√° incorreto ou inv√°lido.',
            'solucao' => 'Verifique e corrija o CPF nas configura√ß√µes.'
        ],

        // Erros de Data e Hor√°rio
        '228' => [
            'titulo' => 'Data de Emiss√£o Atrasada',
            'descricao' => 'A data de emiss√£o est√° muito atrasada (mais de 30 dias).',
            'solucao' => 'Ajuste a data de emiss√£o para uma data mais recente.'
        ],
        '703' => [
            'titulo' => 'Data de Emiss√£o Futura',
            'descricao' => 'A data de emiss√£o est√° no futuro.',
            'solucao' => 'Ajuste a data de emiss√£o para a data atual ou anterior.'
        ],

        // Erros de Chave de Acesso
        '502' => [
            'titulo' => 'Chave de Acesso Inv√°lida',
            'descricao' => 'A chave de acesso n√£o corresponde aos dados da NFe.',
            'solucao' => 'Regenere a NFe para criar uma nova chave de acesso v√°lida.'
        ],
        '253' => [
            'titulo' => 'D√≠gito Verificador Inv√°lido',
            'descricao' => 'O d√≠gito verificador da chave de acesso est√° incorreto.',
            'solucao' => 'Regenere a NFe para corrigir o d√≠gito verificador.'
        ],

        // Erros de Ambiente
        '252' => [
            'titulo' => 'Ambiente Incorreto',
            'descricao' => 'O ambiente da NFe n√£o corresponde ao ambiente do servidor.',
            'solucao' => 'Verifique se est√° emitindo no ambiente correto (produ√ß√£o/homologa√ß√£o).'
        ],

        // Erros de UF e Localiza√ß√£o
        '226' => [
            'titulo' => 'UF Incorreta',
            'descricao' => 'A UF do emitente n√£o corresponde √† UF autorizadora.',
            'solucao' => 'Verifique se a UF da empresa est√° configurada corretamente.'
        ],
        '270' => [
            'titulo' => 'Munic√≠pio Inexistente',
            'descricao' => 'O c√≥digo do munic√≠pio n√£o existe na tabela do IBGE.',
            'solucao' => 'Verifique e corrija o c√≥digo do munic√≠pio da empresa.'
        ],
        '272' => [
            'titulo' => 'Munic√≠pio Inexistente',
            'descricao' => 'O c√≥digo do munic√≠pio do emitente n√£o existe.',
            'solucao' => 'Verifique e corrija o c√≥digo do munic√≠pio da empresa.'
        ],

        // Erros de Certificado
        '280' => [
            'titulo' => 'Certificado Digital Inv√°lido',
            'descricao' => 'O certificado digital est√° vencido ou inv√°lido.',
            'solucao' => 'Renove ou configure um certificado digital v√°lido.'
        ],

        // Erros de Produtos e Impostos
        '897' => [
            'titulo' => 'C√≥digo Num√©rico Inv√°lido',
            'descricao' => 'O c√≥digo num√©rico da NFe est√° em formato inv√°lido.',
            'solucao' => 'Regenere a NFe para criar um novo c√≥digo num√©rico v√°lido.'
        ],

        // Erros de Produtos
        '611' => [
            'titulo' => 'C√≥digo EAN/GTIN Inv√°lido',
            'descricao' => 'O c√≥digo de barras EAN/GTIN de um ou mais produtos est√° incorreto.',
            'solucao' => 'Verifique e corrija os c√≥digos EAN/GTIN dos produtos ou deixe em branco se n√£o possuir.'
        ],

        // Erros de Processamento
        '103' => [
            'titulo' => 'Lote em Processamento',
            'descricao' => 'A NFe foi enviada e est√° sendo processada pela SEFAZ.',
            'solucao' => 'Aguarde alguns segundos e consulte o status novamente.'
        ]
    ];

    if (isset($errosComuns[$status])) {
        $erro = $errosComuns[$status];
        return [
            'titulo' => $erro['titulo'],
            'descricao' => $erro['descricao'],
            'solucao' => $erro['solucao'],
            'status_original' => $status,
            'motivo_original' => $motivo
        ];
    }

    return [
        'titulo' => 'Erro na Valida√ß√£o da NFe',
        'descricao' => $motivo,
        'solucao' => 'Verifique os dados da NFe e tente novamente.',
        'status_original' => $status,
        'motivo_original' => $motivo
    ];
}

try {
    logDetalhado('001', 'Iniciando emiss√£o de NFe modelo 55');
    error_log("üöÄ CHECKPOINT 1: Iniciando emiss√£o de NFe modelo 55");

    // ‚úÖ ADICIONAR TRATAMENTO DE ERRO FATAL
    register_shutdown_function(function() {
        $error = error_get_last();
        if ($error && in_array($error['type'], [E_ERROR, E_PARSE, E_CORE_ERROR, E_COMPILE_ERROR])) {
            error_log("‚ùå ERRO FATAL NFe: " . $error['message'] . " em " . $error['file'] . " linha " . $error['line']);

            if (!headers_sent()) {
                http_response_code(500);
                echo json_encode([
                    'success' => false,
                    'error' => 'Erro fatal no servidor: ' . $error['message'],
                    'error_type' => 'fatal_error',
                    'timestamp' => date('Y-m-d H:i:s'),
                    'debug_info' => [
                        'file' => basename($error['file']),
                        'line' => $error['line'],
                        'step' => 'FATAL_ERROR'
                    ]
                ], JSON_UNESCAPED_UNICODE);
            }
        }
    });

    // Validar m√©todo
    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
        logDetalhado('002', 'Erro: M√©todo n√£o permitido', ['method' => $_SERVER['REQUEST_METHOD']]);
        throw new Exception('M√©todo n√£o permitido. Use POST.');
    }

    logDetalhado('003', 'M√©todo POST validado');
    error_log("‚úÖ CHECKPOINT 2: M√©todo POST validado");

    // Receber dados
    $rawInput = file_get_contents('php://input');
    logDetalhado('004', 'Dados brutos recebidos', ['size' => strlen($rawInput)]);
    error_log("‚úÖ CHECKPOINT 3: Dados brutos recebidos - " . strlen($rawInput) . " bytes");

    $input = json_decode($rawInput, true);

    if (!$input) {
        logDetalhado('005', 'Erro: JSON inv√°lido', ['raw_input' => substr($rawInput, 0, 500)]);
        throw new Exception('Dados JSON inv√°lidos');
    }

    logDetalhado('006', 'JSON decodificado com sucesso', ['keys' => array_keys($input)]);
    error_log("‚úÖ CHECKPOINT 4: JSON decodificado com sucesso");
    
    // Validar empresa_id (OBRIGAT√ìRIO para multi-tenant)
    $empresaId = $input['empresa_id'] ?? null;

    if (!$empresaId) {
        error_log("‚ùå ERRO: empresa_id vazio ou n√£o informado");
        error_log("Input recebido: " . json_encode($input));
        throw new Exception('empresa_id √© obrigat√≥rio');
    }

    error_log("‚úÖ empresa_id v√°lido: " . $empresaId);

    if (!preg_match('/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i', $empresaId)) {
        throw new Exception('empresa_id inv√°lido');
    }

    // üéØ BUSCAR CONFIGURA√á√ÉO REAL DA EMPRESA (SEM FALLBACKS)
    error_log("NFE: Buscando configura√ß√£o real da empresa {$empresaId}");

    // Verificar se dados da empresa est√£o completos no payload
    // Se n√£o estiverem, buscar do banco de dados
    $empresaConfigCompleta = true;
    $nfeData = $input['nfe_data'] ?? $input;

    if (empty($nfeData['empresa']['uf']) ||
        empty($nfeData['empresa']['codigo_municipio']) ||
        empty($nfeData['ambiente'])) {
        $empresaConfigCompleta = false;
        error_log("NFE: Dados da empresa incompletos no payload, buscando do banco");
    }
    
    // Carregar certificado da empresa
    $certificadoPath = "../storage/certificados/empresa_{$empresaId}.pfx";
    $metadataPath = "../storage/certificados/empresa_{$empresaId}.json";
    
    if (!file_exists($certificadoPath) || !file_exists($metadataPath)) {
        throw new Exception('Certificado n√£o encontrado para esta empresa');
    }
    
    $metadata = json_decode(file_get_contents($metadataPath), true);
    $certificado = file_get_contents($certificadoPath);
    
    // Extrair dados da NFe do payload (formato do frontend)
    $nfeData = $input['nfe_data'] ?? $input;

    // Log da informa√ß√£o adicional recebida
    error_log("NFE: Informa√ß√£o adicional recebida: " . ($nfeData['informacao_adicional'] ?? 'VAZIO'));
    error_log("NFE: Dados recebidos - keys: " . implode(', ', array_keys($nfeData)));

    // Valida√ß√£o b√°sica dos dados recebidos

    // Salvar logs detalhados em arquivo espec√≠fico para debug
    $debugFile = '/tmp/nfe_debug.log';
    $debugLog = "\n=== DEBUG NFe - " . date('Y-m-d H:i:s') . " ===\n";
    $debugLog .= "Empresa presente: " . (isset($nfeData['empresa']) ? 'SIM' : 'N√ÉO') . "\n";
    $debugLog .= "Destinat√°rio presente: " . (isset($nfeData['destinatario']) ? 'SIM' : 'N√ÉO') . "\n";
    $debugLog .= "Produtos presente: " . (isset($nfeData['produtos']) ? 'SIM (' . count($nfeData['produtos']) . ' produtos)' : 'N√ÉO') . "\n";
    $debugLog .= "Chaves principais: " . implode(', ', array_keys($nfeData)) . "\n";
    $debugLog .= "=== ESTRUTURA COMPLETA ===\n";
    $debugLog .= json_encode($nfeData, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . "\n";
    $debugLog .= "=== FIM DEBUG ===\n\n";

    file_put_contents($debugFile, $debugLog, FILE_APPEND | LOCK_EX);

    // Log simples no error_log tamb√©m
    error_log("NFe Debug: Dados salvos em $debugFile");

    // Validar dados m√≠nimos
    if (!isset($nfeData['empresa']) || !isset($nfeData['destinatario']) || !isset($nfeData['produtos'])) {
        error_log("ERRO: Dados da NFe incompletos!");
        error_log("Faltando - Empresa: " . (!isset($nfeData['empresa']) ? 'SIM' : 'N√ÉO'));
        error_log("Faltando - Destinat√°rio: " . (!isset($nfeData['destinatario']) ? 'SIM' : 'N√ÉO'));
        error_log("Faltando - Produtos: " . (!isset($nfeData['produtos']) ? 'SIM' : 'N√ÉO'));
        error_log("Dados recebidos completos: " . json_encode($nfeData, JSON_PRETTY_PRINT));
        throw new Exception('Dados da NFe incompletos - verifique se todos os campos obrigat√≥rios est√£o preenchidos');
    }

    // Configura√ß√£o da empresa (USANDO DADOS REAIS DA EMPRESA)
    $empresa = $nfeData['empresa'];

    // Validar ambiente obrigat√≥rio (SEM FALLBACK - deve vir da tabela nfe_config)
    if (empty($nfeData['ambiente'])) {
        throw new Exception('Ambiente NFe √© obrigat√≥rio (deve vir da configura√ß√£o da empresa)');
    }
    $ambiente = $nfeData['ambiente'] === 'producao' ? 1 : 2;
    
    // Validar dados obrigat√≥rios da empresa - SEM FALLBACKS
    if (empty($empresa['razao_social'])) {
        throw new Exception('Raz√£o social da empresa √© obrigat√≥ria');
    }
    if (empty($empresa['cnpj'])) {
        throw new Exception('CNPJ da empresa √© obrigat√≥rio');
    }
    if (empty($empresa['uf'])) {
        throw new Exception('UF da empresa √© obrigat√≥ria');
    }

    $cnpjLimpo = preg_replace('/[^0-9]/', '', $empresa['cnpj']);
    if (strlen($cnpjLimpo) !== 14) {
        throw new Exception('CNPJ da empresa deve ter 14 d√≠gitos');
    }

    $config = [
        "atualizacao" => date('Y-m-d H:i:s'),
        "tpAmb" => $ambiente,
        "razaosocial" => $empresa['razao_social'],
        "cnpj" => $cnpjLimpo,
        "siglaUF" => $empresa['uf'],
        "schemes" => "PL_009_V4",
        "versao" => '4.00',
        // ‚úÖ DESABILITAR cria√ß√£o autom√°tica de pastas pela biblioteca
        "pathNFePHP" => null
    ];
    
    // Criar objeto Certificate
    error_log("‚úÖ CHECKPOINT 5: Criando certificado digital");
    $certificate = \NFePHP\Common\Certificate::readPfx($certificado, $metadata['password'] ?? '');
    error_log("‚úÖ CHECKPOINT 6: Certificado digital criado com sucesso");

    // Inicializar Tools (M√âTODO NATIVO)
    error_log("‚úÖ CHECKPOINT 7: Inicializando Tools NFePHP");
    $tools = new \NFePHP\NFe\Tools(json_encode($config), $certificate);
    $tools->model('55'); // Modelo NFe
    error_log("‚úÖ CHECKPOINT 8: Tools NFePHP inicializado com sucesso");

    // ‚úÖ DESABILITAR cria√ß√£o autom√°tica de diret√≥rios pela biblioteca
    // Isso evita que a biblioteca crie pastas 55/65 no storage raiz
    if (method_exists($tools, 'setPathNFePHP')) {
        $tools->setPathNFePHP(null);
    }

    // Inicializar Make (M√âTODO NATIVO)
    error_log("‚úÖ CHECKPOINT 9: Inicializando Make NFePHP");
    $make = new \NFePHP\NFe\Make();
    error_log("‚úÖ CHECKPOINT 10: Make NFePHP inicializado com sucesso");
    
    // MONTAGEM DA NFe USANDO M√âTODOS NATIVOS DA BIBLIOTECA
    // Identifica√ß√£o da NFe
    $identificacao = $nfeData['identificacao'] ?? [];

    // C√≥digo UF din√¢mico baseado na empresa (SEM FALLBACKS)
    $codigosUF = [
        'AC' => 12, 'AL' => 17, 'AP' => 16, 'AM' => 13, 'BA' => 29,
        'CE' => 23, 'DF' => 53, 'ES' => 32, 'GO' => 52, 'MA' => 21,
        'MT' => 51, 'MS' => 50, 'MG' => 31, 'PA' => 15, 'PB' => 25,
        'PR' => 41, 'PE' => 26, 'PI' => 22, 'RJ' => 33, 'RN' => 24,
        'RS' => 43, 'RO' => 11, 'RR' => 14, 'SC' => 42, 'SP' => 35,
        'SE' => 28, 'TO' => 17
    ];

    // Validar UF obrigat√≥ria (SEM FALLBACK)
    if (empty($empresa['uf'])) {
        throw new Exception('UF da empresa √© obrigat√≥ria');
    }
    $uf = $empresa['uf'];

    // Validar se UF existe na tabela de c√≥digos
    if (!isset($codigosUF[$uf])) {
        throw new Exception("UF '{$uf}' n√£o √© v√°lida");
    }

    // CRIAR ESTRUTURA INFNFE
    $std = new stdClass();
    $std->versao = '4.00';
    $std->Id = null; // Ser√° gerado automaticamente
    $std->pk_nItem = null;

    // USAR M√âTODO NATIVO PARA ADICIONAR IDENTIFICA√á√ÉO
    $make->taginfNFe($std);

    // ‚úÖ ADICIONADO: Processar chaves de refer√™ncia (obrigat√≥rias para finalidades 2, 3 e 4)
    $chavesRef = $nfeData['chaves_ref'] ?? [];
    $finalidade = $identificacao['finalidade'] ?? '1';

    error_log("üîç DEBUG CHAVES REF - Dados recebidos:");
    error_log("  - Finalidade: " . $finalidade);
    error_log("  - Quantidade de chaves: " . count($chavesRef));
    error_log("  - Estrutura identificacao: " . json_encode($identificacao));

    // ‚úÖ DEBUG: Verificar se finalidade est√° sendo definida corretamente
    if (empty($finalidade)) {
        error_log("‚ùå ERRO: Finalidade vazia ou n√£o definida");
        throw new Exception('Finalidade da NFe √© obrigat√≥ria');
    }

    // ‚úÖ CORRE√á√ÉO: Regras oficiais de chave de refer√™ncia
    // Finalidade 1 (Normal) = OPCIONAL (se informada, deve aparecer no XML/DANFE)
    // Finalidade 2 (Complementar) = OBRIGAT√ìRIA
    // Finalidade 3 (Ajuste) = OBRIGAT√ìRIA
    // Finalidade 4 (Devolu√ß√£o) = OBRIGAT√ìRIA
    $finalidadeExigeChave = in_array($finalidade, ['2', '3', '4']);

    if ($finalidadeExigeChave) {
        error_log("‚úÖ Finalidade {$finalidade} exige chave de refer√™ncia obrigat√≥ria");

        if (empty($chavesRef)) {
            error_log("‚ùå ERRO: Finalidade {$finalidade} exige chave de refer√™ncia, mas nenhuma foi informada");
            throw new Exception("NFe com finalidade {$finalidade} deve ter pelo menos uma chave de refer√™ncia");
        }
    }

    // ‚úÖ CORRE√á√ÉO: Processar chaves de refer√™ncia se informadas (independente da finalidade)
    if (!empty($chavesRef)) {
        error_log("‚úÖ Processando " . count($chavesRef) . " chave(s) de refer√™ncia para finalidade {$finalidade}");

        foreach ($chavesRef as $index => $chaveRef) {
            $chave = $chaveRef['chave'] ?? '';

            if (empty($chave) || strlen($chave) !== 44) {
                error_log("‚ùå ERRO: Chave de refer√™ncia {$index} inv√°lida: {$chave}");
                throw new Exception("Chave de refer√™ncia " . ($index + 1) . " deve ter 44 d√≠gitos");
            }

            // ‚úÖ CORRE√á√ÉO: Usar m√©todo correto tagrefNFe() em vez de tagNFref()
            $stdRef = new stdClass();
            $stdRef->refNFe = $chave;

            $make->tagrefNFe($stdRef);
            error_log("‚úÖ Chave de refer√™ncia adicionada: {$chave}");
        }
    } else {
        if ($finalidadeExigeChave) {
            error_log("‚ùå ERRO: Finalidade {$finalidade} exige chave de refer√™ncia");
        } else {
            error_log("‚ÑπÔ∏è Finalidade {$finalidade} - nenhuma chave de refer√™ncia informada (opcional)");
        }
    }

    // CRIAR TAG IDE (IDENTIFICA√á√ÉO) - OBRIGAT√ìRIO ANTES DOS PRODUTOS
    $std = new stdClass();
    $std->cUF = $codigosUF[$uf]; // Usar c√≥digo real da UF da empresa (SEM FALLBACK)

    // ‚úÖ USAR C√ìDIGO NUM√âRICO DO FRONTEND (SEM FALLBACK)
    $codigoNumerico = $identificacao['codigo_numerico'] ?? null;
    if (empty($codigoNumerico)) {
        throw new Exception('C√≥digo num√©rico da NFe √© obrigat√≥rio');
    }
    $std->cNF = str_pad($codigoNumerico, 8, '0', STR_PAD_LEFT);

    $std->natOp = $identificacao['natureza_operacao'] ?? 'Venda de mercadoria';
    $std->mod = 55; // NFe
    $std->serie = (int)($identificacao['serie'] ?? 1);
    $std->nNF = (int)($identificacao['numero'] ?? 1);
    $std->dhEmi = date('Y-m-d\TH:i:sP'); // ‚úÖ Agora com timezone brasileiro
    $std->tpNF = 1; // Sa√≠da
    $std->idDest = 1; // Opera√ß√£o interna

    // ‚úÖ ADICIONADO: Finalidade da emiss√£o (obrigat√≥rio para chaves de refer√™ncia)
    $std->finNFe = (int)$finalidade; // 1=Normal, 2=Complementar, 3=Ajuste, 4=Devolu√ß√£o
    error_log("‚úÖ Finalidade NFe definida: {$finalidade}");

    // Validar c√≥digo do munic√≠pio obrigat√≥rio (SEM FALLBACK)
    if (empty($empresa['codigo_municipio'])) {
        throw new Exception('C√≥digo do munic√≠pio da empresa √© obrigat√≥rio');
    }
    $std->cMunFG = (int)$empresa['codigo_municipio']; // Usar c√≥digo real do munic√≠pio da empresa

    $std->tpImp = 1; // DANFE normal
    $std->tpEmis = 1; // Emiss√£o normal
    $std->cDV = 0;
    $std->tpAmb = $ambiente;
    // ‚úÖ REMOVIDO: $std->finNFe = 1; (j√° definido acima com valor correto)
    $std->indFinal = 1; // Consumidor final
    $std->indPres = 1; // Presencial
    $std->procEmi = 0; // Aplicativo do contribuinte
    $std->verProc = '1.0.0';

    $make->tagide($std);

    // Emitente (M√âTODO NATIVO) - SEM FALLBACKS
    $std = new stdClass();
    $std->xNome = $empresa['razao_social']; // J√Å VALIDADO ACIMA
    $std->CNPJ = $cnpjLimpo; // J√Å VALIDADO ACIMA
    $std->xFant = $empresa['nome_fantasia'] ?? null; // OPCIONAL

    // Validar IE obrigat√≥ria
    if (empty($empresa['inscricao_estadual'])) {
        throw new Exception('Inscri√ß√£o Estadual da empresa √© obrigat√≥ria');
    }
    $std->IE = $empresa['inscricao_estadual'];

    // Validar regime tribut√°rio obrigat√≥rio
    if (empty($empresa['regime_tributario'])) {
        throw new Exception('Regime tribut√°rio da empresa √© obrigat√≥rio');
    }
    $std->CRT = (int)$empresa['regime_tributario'];

    $make->tagemit($std);

    // Endere√ßo do emitente (M√âTODO NATIVO) - SEM FALLBACKS
    $endereco = $empresa['endereco'] ?? [];

    // Validar dados obrigat√≥rios do endere√ßo
    if (empty($endereco['logradouro'])) {
        throw new Exception('Logradouro da empresa √© obrigat√≥rio');
    }
    if (empty($endereco['numero'])) {
        throw new Exception('N√∫mero do endere√ßo da empresa √© obrigat√≥rio');
    }
    if (empty($endereco['bairro'])) {
        throw new Exception('Bairro da empresa √© obrigat√≥rio');
    }
    if (empty($endereco['cidade'])) {
        throw new Exception('Cidade da empresa √© obrigat√≥ria');
    }
    if (empty($endereco['cep'])) {
        throw new Exception('CEP da empresa √© obrigat√≥rio');
    }
    if (empty($empresa['codigo_municipio'])) {
        throw new Exception('C√≥digo do munic√≠pio da empresa √© obrigat√≥rio');
    }

    $std = new stdClass();
    $std->xLgr = $endereco['logradouro'];
    $std->nro = $endereco['numero'];
    $std->xBairro = $endereco['bairro'];
    $std->cMun = (int)$empresa['codigo_municipio'];
    $std->xMun = $endereco['cidade'];
    $std->UF = $empresa['uf']; // J√Å VALIDADO ACIMA
    $std->CEP = preg_replace('/[^0-9]/', '', $endereco['cep']);
    $std->cPais = 1058;
    $std->xPais = 'BRASIL';

    $make->tagenderEmit($std);

    // Destinat√°rio (M√âTODO NATIVO)
    $destinatario = $nfeData['destinatario'];

    $std = new stdClass();

    // Tentar diferentes campos para o nome do destinat√°rio
    $nomeDestinatario = '';
    if (isset($destinatario['nome'])) {
        $nomeDestinatario = $destinatario['nome'];
    } elseif (isset($destinatario['name'])) {
        $nomeDestinatario = $destinatario['name'];
    } elseif (isset($destinatario['razao_social'])) {
        $nomeDestinatario = $destinatario['razao_social'];
    } elseif (isset($destinatario['cliente'])) {
        $nomeDestinatario = $destinatario['cliente'];
    }

    if (empty($nomeDestinatario)) {
        throw new Exception("Nome do destinat√°rio n√£o encontrado");
    }

    $std->xNome = $nomeDestinatario;

    $documento = preg_replace('/[^0-9]/', '', $destinatario['documento'] ?? '');
    if (strlen($documento) === 11) {
        $std->CPF = $documento;
        $std->indIEDest = 9; // 9=N√£o contribuinte (pessoa f√≠sica)
    } else {
        $std->CNPJ = $documento;
        $std->indIEDest = 9; // 9=N√£o contribuinte (assumindo n√£o contribuinte)
        // Para contribuintes: 1=Contribuinte ICMS, 2=Contribuinte isento, 9=N√£o contribuinte
    }

    $make->tagdest($std);

    // Endere√ßo do destinat√°rio (OBRIGAT√ìRIO - SEM FALLBACKS FICT√çCIOS)
    $enderecoDestinatario = $destinatario['endereco'] ?? [];

    if (!empty($enderecoDestinatario)) {
        // Validar dados obrigat√≥rios do endere√ßo do destinat√°rio (SEM FALLBACKS)
        if (empty($enderecoDestinatario['logradouro'])) {
            throw new Exception('Logradouro do destinat√°rio √© obrigat√≥rio');
        }
        if (empty($enderecoDestinatario['numero'])) {
            throw new Exception('N√∫mero do endere√ßo do destinat√°rio √© obrigat√≥rio');
        }
        if (empty($enderecoDestinatario['bairro'])) {
            throw new Exception('Bairro do destinat√°rio √© obrigat√≥rio');
        }
        if (empty($enderecoDestinatario['codigo_municipio'])) {
            throw new Exception('C√≥digo do munic√≠pio do destinat√°rio √© obrigat√≥rio');
        }
        if (empty($enderecoDestinatario['cidade'])) {
            throw new Exception('Cidade do destinat√°rio √© obrigat√≥ria');
        }
        if (empty($enderecoDestinatario['uf'])) {
            throw new Exception('UF do destinat√°rio √© obrigat√≥ria');
        }
        if (empty($enderecoDestinatario['cep'])) {
            throw new Exception('CEP do destinat√°rio √© obrigat√≥rio');
        }

        $std = new stdClass();
        $std->xLgr = $enderecoDestinatario['logradouro'];
        $std->nro = $enderecoDestinatario['numero'];
        $std->xBairro = $enderecoDestinatario['bairro'];
        $std->cMun = (int)$enderecoDestinatario['codigo_municipio'];
        $std->xMun = $enderecoDestinatario['cidade'];
        $std->UF = $enderecoDestinatario['uf'];
        $std->CEP = preg_replace('/[^0-9]/', '', $enderecoDestinatario['cep']);
        $std->cPais = 1058;
        $std->xPais = 'BRASIL';

        $make->tagenderDest($std);
    } else {
        throw new Exception('Endere√ßo do destinat√°rio √© obrigat√≥rio para NFe');
    }

    // Produtos (M√âTODO NATIVO) - USANDO DADOS FISCAIS REAIS
    $produtos = $nfeData['produtos'] ?? [];

    // ‚úÖ VALIDA√á√ÉO CR√çTICA: Verificar se h√° produtos v√°lidos
    if (empty($produtos)) {
        error_log("‚ùå ERRO CR√çTICO: Nenhum produto encontrado nos dados da NFe");
        error_log("üìä DADOS RECEBIDOS: " . json_encode($nfeData, JSON_UNESCAPED_UNICODE));
        throw new Exception('NFe deve conter pelo menos um produto');
    }

    error_log("üöÄ INICIANDO PROCESSAMENTO NFe:");
    error_log("  - Total de produtos: " . count($produtos));
    error_log("  - Empresa ID: " . ($nfeData['empresa_id'] ?? 'N/A'));
    error_log("  - Regime tribut√°rio: " . ($nfeData['regime_tributario'] ?? 'N/A'));

    // ‚úÖ CONTADOR DE TAGS CRIADAS PARA DIAGN√ìSTICO
    $contadorTags = [
        'produtos' => 0,
        'impostos' => 0,
        'icms' => 0,
        'pis' => 0,
        'cofins' => 0
    ];

    error_log("üìä CONTADORES INICIALIZADOS: " . json_encode($contadorTags));

    foreach ($produtos as $index => $produto) {
        $item = $index + 1;

        error_log("üîç PROCESSANDO PRODUTO {$item}:");
        error_log("  - Dados recebidos: " . json_encode($produto, JSON_UNESCAPED_UNICODE));

        // ‚úÖ TIMEOUT DE SEGURAN√áA: Verificar se n√£o est√° demorando muito
        $tempoInicio = microtime(true);

        try {

        // ‚úÖ VALIDA√á√ÉO CR√çTICA: Verificar se produto tem dados m√≠nimos
        if (empty($produto) || !is_array($produto)) {
            error_log("‚ùå PRODUTO {$item}: Dados inv√°lidos ou vazios - PULANDO");
            continue;
        }

        // ‚úÖ VALIDA√á√ÉO: Verificar campos obrigat√≥rios do produto
        $camposFaltando = [];

        // Verificar c√≥digo do produto
        if (empty($produto['codigo']) && empty($produto['id'])) {
            $camposFaltando[] = 'codigo';
        }

        // Verificar nome/descri√ß√£o do produto (aceitar qualquer um dos campos)
        $temNome = !empty($produto['descricao']) || !empty($produto['nome']) ||
                   !empty($produto['name']) || !empty($produto['produto']);
        if (!$temNome) {
            $camposFaltando[] = 'nome/descricao';
        }

        // Verificar NCM
        if (empty($produto['ncm'])) {
            $camposFaltando[] = 'ncm';
        }

        // Verificar CFOP
        if (empty($produto['cfop'])) {
            $camposFaltando[] = 'cfop';
        }

        if (!empty($camposFaltando)) {
            error_log("‚ùå PRODUTO {$item}: Campos obrigat√≥rios faltando: " . implode(', ', $camposFaltando));
            error_log("üìä ESTADO DOS CONTADORES NO MOMENTO DO ERRO:");
            error_log("  - Produtos: {$contadorTags['produtos']}");
            error_log("  - IMPOSTO: {$contadorTags['impostos']}");
            error_log("  - ICMS/ICMSSN: {$contadorTags['icms']}");
            error_log("  - PIS: {$contadorTags['pis']}");
            error_log("  - COFINS: {$contadorTags['cofins']}");
            
            throw new Exception("Produto {$item}: Campos obrigat√≥rios faltando: " . implode(', ', $camposFaltando));
        }

        error_log("‚úÖ PRODUTO {$item}: Valida√ß√£o inicial aprovada - iniciando cria√ß√£o das tags");

        // Log dos dados fiscais do produto
        error_log("NFE: Produto {$item} - NCM: " . ($produto['ncm'] ?? 'N/A') .
                  ", CFOP: " . ($produto['cfop'] ?? 'N/A') .
                  ", ICMS: " . ($produto['aliquota_icms'] ?? 0) . "%" .
                  ", CST ICMS: " . ($produto['cst_icms'] ?? $produto['csosn_icms'] ?? 'N/A') .
                  ", Origem: " . ($produto['origem_produto'] ?? 0) .
                  ", EAN: " . ($produto['ean'] ?? 'VAZIO') .
                  ", CEST: " . ($produto['cest'] ?? 'VAZIO')); // ‚úÖ ADICIONADO: Log do CEST

        // ‚úÖ LOG DETALHADO DA CONFIGURA√á√ÉO TRIBUT√ÅRIA
        logDetalhado("PRODUTO_{$item}_CONFIG_TRIBUTARIA", "Configura√ß√£o tribut√°ria do produto", [
            'ncm' => $produto['ncm'] ?? 'N/A',
            'cfop' => $produto['cfop'] ?? 'N/A',
            'cest' => $produto['cest'] ?? 'VAZIO',
            'cst_icms' => $produto['cst_icms'] ?? 'N/A',
            'csosn_icms' => $produto['csosn_icms'] ?? 'N/A',
            'aliquota_icms' => $produto['aliquota_icms'] ?? 0,
            'origem_produto' => $produto['origem_produto'] ?? 0,
            'situacao_tributaria' => $produto['situacao_tributaria'] ?? 'N/A'
        ]);

        // ‚úÖ VALIDA√á√ÉO DETALHADA PARA SUBSTITUI√á√ÉO TRIBUT√ÅRIA
        $isSubstituicaoTributaria = ($produto['csosn_icms'] == '500' || $produto['cfop'] == '5405');
        if ($isSubstituicaoTributaria) {
            logDetalhado("PRODUTO_{$item}_ST_DETECTADA", "Produto com Substitui√ß√£o Tribut√°ria detectado");

            $errosST = [];

            // Validar CEST
            if (empty($produto['cest'])) {
                $errosST[] = "CEST obrigat√≥rio para ST";
            }

            // Validar al√≠quota ICMS
            if (empty($produto['aliquota_icms']) || $produto['aliquota_icms'] == 0) {
                $errosST[] = "Al√≠quota ICMS obrigat√≥ria para ST (ex: 18%)";
            }

            // Validar CFOP
            if ($produto['cfop'] != '5405') {
                $errosST[] = "CFOP deve ser 5405 para ST (atual: " . ($produto['cfop'] ?? 'N/A') . ")";
            }

            // Validar CSOSN
            if ($produto['csosn_icms'] != '500') {
                $errosST[] = "CSOSN deve ser 500 para ST (atual: " . ($produto['csosn_icms'] ?? 'N/A') . ")";
            }

            if (!empty($errosST)) {
                logDetalhado("PRODUTO_{$item}_ST_ERROS", "Erros de valida√ß√£o ST encontrados", [
                    'erros' => $errosST,
                    'total_erros' => count($errosST)
                ]);

                $mensagemErro = "Produto {$item} - Erros de Substitui√ß√£o Tribut√°ria:\n";
                foreach ($errosST as $erro) {
                    $mensagemErro .= "‚Ä¢ {$erro}\n";
                }

                throw new Exception($mensagemErro);
            } else {
                logDetalhado("PRODUTO_{$item}_ST_VALIDACAO_OK", "Valida√ß√£o ST passou - todos os campos obrigat√≥rios presentes");
            }
        }

        // Log da tag ICMS que ser√° usada (ser√° atualizado ap√≥s processamento)

        // Produto - Mapear campos corretamente
        $std = new stdClass();
        $std->item = $item;
        $std->cProd = $produto['codigo'] ?? $produto['id'] ?? "PROD{$item}";
        // ‚úÖ CORRE√á√ÉO CR√çTICA: Validar EAN/GTIN - deve ser v√°lido ou 'SEM GTIN'
        $ean = $produto['ean'] ?? $produto['codigo_barras'] ?? '';
        $eanValido = false;

        if (!empty($ean) && preg_match('/^\d{8}$|^\d{12}$|^\d{13}$|^\d{14}$/', $ean)) {
            // EAN v√°lido - usar o c√≥digo
            $std->cEAN = $ean;
            $eanValido = true;
            logDetalhado("PRODUTO_{$item}_EAN_VALIDO", "EAN v√°lido encontrado", ['ean' => $ean]);
        } else {
            // EAN vazio ou inv√°lido - usar 'SEM GTIN'
            $std->cEAN = 'SEM GTIN';
            logDetalhado("PRODUTO_{$item}_EAN_INVALIDO", "EAN inv√°lido ou vazio - usando SEM GTIN", ['ean_original' => $ean]);
        }

        // Validar nome do produto obrigat√≥rio (SEM FALLBACKS)
        $nomeProduto = '';
        if (isset($produto['descricao'])) {
            $nomeProduto = $produto['descricao'];
        } elseif (isset($produto['nome'])) {
            $nomeProduto = $produto['nome'];
        } elseif (isset($produto['name'])) {
            $nomeProduto = $produto['name'];
        } elseif (isset($produto['produto'])) {
            $nomeProduto = $produto['produto'];
        }

        if (empty($nomeProduto)) {
            throw new Exception("Nome/descri√ß√£o do produto {$item} √© obrigat√≥rio");
        }

        // Validar dados fiscais obrigat√≥rios do produto (SEM FALLBACKS)
        if (empty($produto['ncm'])) {
            throw new Exception("NCM do produto {$item} ({$nomeProduto}) √© obrigat√≥rio");
        }
        if (empty($produto['cfop'])) {
            throw new Exception("CFOP do produto {$item} ({$nomeProduto}) √© obrigat√≥rio");
        }

        $std->xProd = $nomeProduto;
        $std->NCM = $produto['ncm']; // NCM real obrigat√≥rio

        // ‚úÖ CORRE√á√ÉO CR√çTICA: CEST deve ser adicionado ANTES de tagprod() conforme documenta√ß√£o oficial
        if (!empty($produto['cest'])) {
            $std->CEST = trim($produto['cest']); // CEST real do produto (trim para remover espa√ßos)
            logDetalhado("PRODUTO_{$item}_CEST_INFORMADO", "CEST configurado para tagprod", [
                'cest' => $produto['cest'],
                'cest_trimmed' => trim($produto['cest']),
                'cest_length' => strlen(trim($produto['cest']))
            ]);
        } else {
            logDetalhado("PRODUTO_{$item}_CEST_VAZIO", "CEST n√£o informado - pode causar erro 806 se houver ST");
        }

        $std->CFOP = $produto['cfop']; // CFOP real obrigat√≥rio
        $std->uCom = $produto['unidade'] ?? 'UN';
        $std->qCom = (float)($produto['quantidade'] ?? 1);
        $std->vUnCom = (float)($produto['valor_unitario'] ?? $produto['preco'] ?? 0);
        $std->vProd = (float)($produto['valor_total'] ?? 0);

        // ‚úÖ CORRE√á√ÉO CR√çTICA: cEANTrib deve usar a mesma valida√ß√£o do cEAN
        if ($eanValido) {
            $std->cEANTrib = $ean; // Usar EAN v√°lido
            logDetalhado("PRODUTO_{$item}_EANTRIB_VALIDO", "cEANTrib configurado com EAN v√°lido", ['ean' => $ean]);
        } else {
            $std->cEANTrib = 'SEM GTIN'; // Usar 'SEM GTIN' quando n√£o h√° EAN v√°lido
            logDetalhado("PRODUTO_{$item}_EANTRIB_SEM_GTIN", "cEANTrib configurado como SEM GTIN");
        }

        $std->uTrib = $produto['unidade'] ?? 'UN';
        $std->qTrib = (float)($produto['quantidade'] ?? 1);
        $std->vUnTrib = (float)($produto['valor_unitario'] ?? $produto['preco'] ?? 0);

        // ‚úÖ CORRE√á√ÉO CR√çTICA: Campos opcionais conforme documenta√ß√£o oficial NFe
        // Segundo mjailton.com.br/manualnfe - campos opcionais devem ser omitidos quando zero
        // N√ÉO definir campos opcionais quando n√£o h√° valor - biblioteca NFePHP omite automaticamente

        $std->indTot = 1;    // Indica se valor comp√µe total da NFe (1=Sim)

        // ‚úÖ ADICIONADO: Campos que podem ser obrigat√≥rios para CEST funcionar
        if (!empty($produto['cest'])) {
            // Verificar se h√° campos espec√≠ficos necess√°rios para CEST
            logDetalhado("PRODUTO_{$item}_CEST_CAMPOS_VERIFICACAO", "Verificando campos necess√°rios para CEST", [
                'tem_ncm' => !empty($std->NCM),
                'tem_cfop' => !empty($std->CFOP),
                'tem_cest' => !empty($std->CEST),
                'ncm_valor' => $std->NCM ?? 'VAZIO',
                'cfop_valor' => $std->CFOP ?? 'VAZIO',
                'cest_valor' => $std->CEST ?? 'VAZIO'
            ]);
        }

        $make->tagprod($std);

        // ‚úÖ LOG DO XML DO PRODUTO PARA DEBUG
        try {
            $xmlAtual = $make->getXML();
            if ($xmlAtual && strpos($xmlAtual, '<CEST>') !== false) {
                logDetalhado("PRODUTO_{$item}_XML_CEST_OK", "CEST encontrado no XML gerado");
            } else {
                logDetalhado("PRODUTO_{$item}_XML_CEST_FALTANDO", "CEST N√ÉO encontrado no XML - poss√≠vel causa do erro 806");
            }
        } catch (Exception $e) {
            logDetalhado("PRODUTO_{$item}_XML_ERRO", "Erro ao verificar XML", ['erro' => $e->getMessage()]);
        }

        // ‚úÖ CORRE√á√ÉO CR√çTICA: Tag IMPOSTO deve ser criada AP√ìS todas as tags de tributos
        // Conforme documenta√ß√£o NFePHP, a ordem correta √©:
        // 1. tagprod() - produto
        // 2. tagimposto() - container de impostos
        // 3. tagICMS/tagICMSSN() - ICMS
        // 4. tagPIS() - PIS
        // 5. tagCOFINS() - COFINS

        // PRIMEIRO: Criar container de impostos
        $std = new stdClass();
        $std->item = $item;
        $std->vTotTrib = 0.00; // Valor total dos tributos

        logDetalhado("PRODUTO_{$item}_IMPOSTO_INICIO", "Iniciando cria√ß√£o da tag imposto");
        try {
            $make->tagimposto($std);
            $contadorTags['impostos']++;
            logDetalhado("PRODUTO_{$item}_IMPOSTO_CRIADO", "Tag imposto criada com sucesso");
            error_log("‚úÖ PRODUTO {$item}: Tag IMPOSTO criada (total: {$contadorTags['impostos']})");
        } catch (Exception $e) {
            logDetalhado("PRODUTO_{$item}_IMPOSTO_ERRO", "Erro ao criar tag imposto", [
                'erro' => $e->getMessage(),
                'linha' => $e->getLine(),
                'arquivo' => $e->getFile()
            ]);
            throw $e;
        }

        // ICMS (usando dados reais do produto com tag espec√≠fica)
        $std = new stdClass();
        $std->item = $item;
        $std->orig = (int)($produto['origem_produto'] ?? 0); // Origem real do produto

        // Determinar regime tribut√°rio e usar tag espec√≠fica
        // Verificar regime da empresa (1=Simples Nacional, 2=Simples Nacional - excesso, 3=Regime Normal)
        $regimeTributario = (int)($nfeData['empresa']['regime_tributario'] ?? 1);
        $isSimples = in_array($regimeTributario, [1, 2]); // 1 ou 2 = Simples Nacional

        // ‚úÖ CORRE√á√ÉO CONFORME DOCUMENTA√á√ÉO OFICIAL NFe:
        // "Informar apenas um dos grupos de tributa√ß√£o do ICMS" - mjailton.com.br/manualnfe/tag/detalhe/47
        // NUNCA processar CST e CSOSN simultaneamente - usar apenas o coerente com o regime

        if ($isSimples) {
            // ‚úÖ SIMPLES NACIONAL: Usar APENAS CSOSN, IGNORAR CST
            $temCSOSN = isset($produto['csosn_icms']) && !empty($produto['csosn_icms']);
            $temCST = false; // FOR√áAR false para ignorar CST

            error_log("‚úÖ REGIME SIMPLES NACIONAL - Produto {$item}:");
            error_log("  - Regime: {$regimeTributario} (Simples Nacional)");
            error_log("  - CSOSN: " . ($produto['csosn_icms'] ?? 'VAZIO') . " (ser√° usado)");
            error_log("  - CST: " . ($produto['cst_icms'] ?? 'VAZIO') . " (ser√° IGNORADO)");

        } else {
            // ‚úÖ REGIME NORMAL: Usar APENAS CST, IGNORAR CSOSN
            $temCST = isset($produto['cst_icms']) && !empty($produto['cst_icms']);
            $temCSOSN = false; // FOR√áAR false para ignorar CSOSN

            error_log("‚úÖ REGIME NORMAL - Produto {$item}:");
            error_log("  - Regime: {$regimeTributario} (Regime Normal)");
            error_log("  - CST: " . ($produto['cst_icms'] ?? 'VAZIO') . " (ser√° usado)");
            error_log("  - CSOSN: " . ($produto['csosn_icms'] ?? 'VAZIO') . " (ser√° IGNORADO)");
        }

        if ($isSimples && $temCSOSN) {
            // Simples Nacional - usar CSOSN
            $csosn = $produto['csosn_icms'];
            $std->CSOSN = $csosn;

            // Para Simples Nacional, configurar campos espec√≠ficos
            $aliquotaICMS = (float)($produto['aliquota_icms'] ?? 0);

            if ($csosn === '101' && $aliquotaICMS > 0) {
                // CSOSN 101 - Tributada pelo Simples Nacional com permiss√£o de cr√©dito
                $std->pCredSN = $aliquotaICMS;
                $std->vCredICMSSN = round((float)($produto['valor_total'] ?? 0) * ($aliquotaICMS / 100), 2);
            } elseif ($csosn === '500') {
                // ‚úÖ CORRE√á√ÉO CR√çTICA: CSOSN 500 - Campos obrigat√≥rios conforme documenta√ß√£o oficial
                // Conforme mjailton.com.br/manualnfe/tag/detalhe/66
                $valorProduto = (float)($produto['valor_total'] ?? 0);

                // Campos obrigat√≥rios para CSOSN 500:
                $std->vBCSTRet = $valorProduto; // Base de c√°lculo ST retida (obrigat√≥rio)
                $std->pST = $aliquotaICMS; // Al√≠quota suportada (obrigat√≥rio)
                $std->vICMSSTRet = round($valorProduto * ($aliquotaICMS / 100), 2); // Valor ICMS ST retido (obrigat√≥rio)

                logDetalhado("PRODUTO_{$item}_ST_CAMPOS_OBRIGATORIOS", "Campos ST obrigat√≥rios configurados", [
                    'csosn' => '500',
                    'vBCSTRet' => $std->vBCSTRet,
                    'pST' => $std->pST,
                    'vICMSSTRet' => $std->vICMSSTRet,
                    'valor_produto' => $valorProduto,
                    'aliquota' => $aliquotaICMS
                ]);
            }

            // Usar m√©todo espec√≠fico para Simples Nacional
            try {
                $make->tagICMSSN($std);
                $contadorTags['icms']++;
                logDetalhado("PRODUTO_{$item}_ICMSSN_CRIADO", "Tag ICMSSN criada com sucesso", [
                    'csosn' => $std->CSOSN
                ]);
                error_log("‚úÖ PRODUTO {$item}: Tag ICMSSN criada (total: {$contadorTags['icms']})");
            } catch (Exception $e) {
                logDetalhado("PRODUTO_{$item}_ICMSSN_ERRO", "Erro ao criar tag ICMSSN", [
                    'erro' => $e->getMessage()
                ]);
                throw $e;
            }
        } elseif (!$isSimples && $temCST) {
            // Regime Normal/Lucro Real/Lucro Presumido - usar CST
            $cst = $produto['cst_icms'];
            $std->CST = $cst;

            $aliquotaICMS = (float)($produto['aliquota_icms'] ?? 0);
            $valorBase = (float)($produto['valor_total'] ?? 0);

            // Configurar campos baseados no CST
            if (in_array($cst, ['00', '10', '20', '51'])) {
                // CSTs que t√™m tributa√ß√£o
                $std->modBC = 0; // 0=Margem Valor Agregado (%)
                $std->vBC = $valorBase;
                $std->pICMS = $aliquotaICMS;
                $std->vICMS = round($valorBase * ($aliquotaICMS / 100), 2);

                // Campos espec√≠ficos para alguns CSTs
                if ($cst === '20') {
                    $std->pRedBC = 0; // Percentual de redu√ß√£o da BC
                }
                if ($cst === '10') {
                    $std->modBCST = 0;
                    $std->vBCST = 0;
                    $std->pICMSST = 0;
                    $std->vICMSST = 0;
                }
            } elseif (in_array($cst, ['40', '41', '50'])) {
                // CSTs isentos/n√£o tributados - n√£o precisam de campos adicionais
            } elseif ($cst === '60') {
                // ICMS cobrado anteriormente por ST
                $std->vBCSTRet = 0;
                $std->vICMSSTRet = 0;
            }

            // Usar m√©todo gen√©rico para todos os CSTs
            try {
                $make->tagICMS($std);
                $contadorTags['icms']++;
                logDetalhado("PRODUTO_{$item}_ICMS_CRIADO", "Tag ICMS criada com sucesso", [
                    'cst' => $std->CST
                ]);
                error_log("‚úÖ PRODUTO {$item}: Tag ICMS criada (total: {$contadorTags['icms']})");
            } catch (Exception $e) {
                logDetalhado("PRODUTO_{$item}_ICMS_ERRO", "Erro ao criar tag ICMS", [
                    'erro' => $e->getMessage()
                ]);
                throw $e;
            }
        } else {
            // ‚ùå SEM FALLBACKS - IDENTIFICAR PROBLEMA REAL
            $erro = "Produto {$item} ({$nomeProduto}): DADOS FISCAIS OBRIGAT√ìRIOS AUSENTES\n\n";

            $erro .= "üìä AN√ÅLISE DOS DADOS RECEBIDOS:\n";
            $erro .= "  - Regime da empresa: {$regimeTributario}\n";
            $erro .= "  - √â Simples Nacional: " . ($isSimples ? 'SIM' : 'N√ÉO') . "\n";
            $erro .= "  - Tem CST: " . ($temCST ? 'SIM' : 'N√ÉO') . "\n";
            $erro .= "  - Tem CSOSN: " . ($temCSOSN ? 'SIM' : 'N√ÉO') . "\n";
            $erro .= "  - CST valor: " . ($produto['cst_icms'] ?? 'VAZIO') . "\n";
            $erro .= "  - CSOSN valor: " . ($produto['csosn_icms'] ?? 'VAZIO') . "\n\n";

            $erro .= "üîç DADOS COMPLETOS DO PRODUTO:\n";
            $erro .= json_encode($produto, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . "\n\n";

            if ($isSimples && !$temCSOSN) {
                $erro .= "‚ùå PROBLEMA: Empresa no Simples Nacional mas produto sem CSOSN\n";
                $erro .= "‚úÖ SOLU√á√ÉO: Verificar por que o campo 'csosn_icms' n√£o est√° sendo enviado do frontend\n";
            } elseif (!$isSimples && !$temCST) {
                $erro .= "‚ùå PROBLEMA: Empresa no Regime Normal mas produto sem CST\n";
                $erro .= "‚úÖ SOLU√á√ÉO: Verificar por que o campo 'cst_icms' n√£o est√° sendo enviado do frontend\n";
            } else {
                $erro .= "‚ùå PROBLEMA: Regime tribut√°rio n√£o reconhecido ou dados inconsistentes\n";
            }

            error_log("‚ùå NFE ERRO CR√çTICO - DADOS FISCAIS AUSENTES:");
            error_log($erro);

            throw new Exception($erro);
        }
        
        // PIS (usando dados reais do produto)
        $std = new stdClass();
        $std->item = $item;
        $std->CST = $produto['cst_pis'] ?? '01';

        // Calcular PIS baseado no CST
        $cstPIS = $produto['cst_pis'] ?? '01';
        $valorBase = (float)($produto['valor_total'] ?? 0);

        if (in_array($cstPIS, ['01', '02'])) {
            // PIS tributado - usar al√≠quota padr√£o ou espec√≠fica
            $aliquotaPIS = (float)($produto['aliquota_pis'] ?? 1.65); // 1.65% padr√£o
            $std->vBC = $valorBase;
            $std->pPIS = $aliquotaPIS;
            $std->vPIS = round($valorBase * ($aliquotaPIS / 100), 2);
        } else {
            // PIS isento, n√£o tributado, etc.
            $std->vBC = null;
            $std->pPIS = null;
            $std->vPIS = null;
        }

        try {
            $make->tagPIS($std);
            $contadorTags['pis']++;
            logDetalhado("PRODUTO_{$item}_PIS_CRIADO", "Tag PIS criada com sucesso", [
                'cst' => $std->CST
            ]);
            error_log("‚úÖ PRODUTO {$item}: Tag PIS criada (total: {$contadorTags['pis']})");
        } catch (Exception $e) {
            logDetalhado("PRODUTO_{$item}_PIS_ERRO", "Erro ao criar tag PIS", [
                'erro' => $e->getMessage()
            ]);
            throw $e;
        }
        
        // COFINS (usando dados reais do produto)
        $std = new stdClass();
        $std->item = $item;
        $std->CST = $produto['cst_cofins'] ?? '01';

        // Calcular COFINS baseado no CST
        $cstCOFINS = $produto['cst_cofins'] ?? '01';
        $valorBase = (float)($produto['valor_total'] ?? 0);

        if (in_array($cstCOFINS, ['01', '02'])) {
            // COFINS tributado - usar al√≠quota padr√£o ou espec√≠fica
            $aliquotaCOFINS = (float)($produto['aliquota_cofins'] ?? 7.60); // 7.60% padr√£o
            $std->vBC = $valorBase;
            $std->pCOFINS = $aliquotaCOFINS;
            $std->vCOFINS = round($valorBase * ($aliquotaCOFINS / 100), 2);
        } else {
            // COFINS isento, n√£o tributado, etc.
            $std->vBC = null;
            $std->pCOFINS = null;
            $std->vCOFINS = null;
        }

        try {
            $make->tagCOFINS($std);
            $contadorTags['cofins']++;
            logDetalhado("PRODUTO_{$item}_COFINS_CRIADO", "Tag COFINS criada com sucesso", [
                'cst' => $std->CST
            ]);
            error_log("‚úÖ PRODUTO {$item}: Tag COFINS criada (total: {$contadorTags['cofins']})");
        } catch (Exception $e) {
            logDetalhado("PRODUTO_{$item}_COFINS_ERRO", "Erro ao criar tag COFINS", [
                'erro' => $e->getMessage()
            ]);
            throw $e;
        }

        // ‚úÖ LOG FINAL: Produto processado com sucesso
        $contadorTags['produtos']++;
        error_log("‚úÖ PRODUTO {$item}: Tags fiscais criadas - ICMS/ICMSSN, PIS, COFINS (produto {$contadorTags['produtos']} de " . count($produtos) . ")");

        logDetalhado("PRODUTO_{$item}_TAGS_FINALIZADAS", "Todas as tags do produto processadas", [
            'item' => $item,
            'produto_codigo' => $produto['codigo'] ?? 'N/A',
            'produto_nome' => $produto['nome'] ?? 'N/A'
        ]);

        // ‚úÖ LOG DE TEMPO: Verificar se algum produto est√° demorando muito
        $tempoFinal = microtime(true);
        $tempoProcessamento = round(($tempoFinal - $tempoInicio) * 1000, 2);
        error_log("‚è±Ô∏è PRODUTO {$item}: Processado em {$tempoProcessamento}ms");

        } catch (Exception $produtoError) {
            error_log("‚ùå ERRO NO PROCESSAMENTO DO PRODUTO {$item}: " . $produtoError->getMessage());
            error_log("üìä ESTADO DOS CONTADORES NO MOMENTO DO ERRO:");
            error_log("  - Produtos: {$contadorTags['produtos']}");
            error_log("  - IMPOSTO: {$contadorTags['impostos']}");
            error_log("  - ICMS/ICMSSN: {$contadorTags['icms']}");
            error_log("  - PIS: {$contadorTags['pis']}");
            error_log("  - COFINS: {$contadorTags['cofins']}");
            error_log("üìã DADOS DO PRODUTO COM ERRO: " . json_encode($produto, JSON_UNESCAPED_UNICODE));

            // Re-lan√ßar o erro para parar o processamento
            throw new Exception("Erro no produto {$item}: " . $produtoError->getMessage());
        }
    }

    // ‚úÖ LOG FINAL: Resumo das tags criadas
    error_log("üìä RESUMO TAGS CRIADAS:");
    error_log("  - Produtos processados: {$contadorTags['produtos']} de " . count($produtos));
    error_log("  - Tags IMPOSTO: {$contadorTags['impostos']}");
    error_log("  - Tags ICMS/ICMSSN: {$contadorTags['icms']}");
    error_log("  - Tags PIS: {$contadorTags['pis']}");
    error_log("  - Tags COFINS: {$contadorTags['cofins']}");

    // ‚úÖ VALIDA√á√ÉO CR√çTICA: Verificar se todas as tags foram criadas
    if ($contadorTags['produtos'] !== count($produtos)) {
        throw new Exception("Nem todos os produtos foram processados: {$contadorTags['produtos']} de " . count($produtos));
    }

    if ($contadorTags['impostos'] !== $contadorTags['produtos'] ||
        $contadorTags['icms'] !== $contadorTags['produtos'] ||
        $contadorTags['pis'] !== $contadorTags['produtos'] ||
        $contadorTags['cofins'] !== $contadorTags['produtos']) {

        error_log("‚ùå INCONSIST√äNCIA NAS TAGS DE IMPOSTOS:");
        error_log("  - Esperado: {$contadorTags['produtos']} de cada tipo");
        error_log("  - IMPOSTO: {$contadorTags['impostos']}");
        error_log("  - ICMS: {$contadorTags['icms']}");
        error_log("  - PIS: {$contadorTags['pis']}");
        error_log("  - COFINS: {$contadorTags['cofins']}");

        throw new Exception("Inconsist√™ncia nas tags de impostos - nem todos os produtos t√™m todas as tags fiscais");
    }

    // Totais (CALCULADOS AUTOMATICAMENTE baseado nos produtos)
    $totais = $nfeData['totais'] ?? [];

    // Calcular totais reais baseado nos produtos processados
    $totalProdutos = 0;
    $totalICMSBC = 0;
    $totalICMS = 0;
    $totalPIS = 0;
    $totalCOFINS = 0;

    foreach ($produtos as $produto) {
        $valorProduto = (float)($produto['valor_total'] ?? 0);
        $totalProdutos += $valorProduto;

        // Somar ICMS se tributado
        $aliquotaICMS = (float)($produto['aliquota_icms'] ?? 0);
        if ($aliquotaICMS > 0) {
            $totalICMSBC += $valorProduto;
            $totalICMS += round($valorProduto * ($aliquotaICMS / 100), 2);
        }

        // Somar PIS se tributado
        $cstPIS = $produto['cst_pis'] ?? '01';
        if (in_array($cstPIS, ['01', '02'])) {
            $aliquotaPIS = (float)($produto['aliquota_pis'] ?? 1.65);
            $totalPIS += round($valorProduto * ($aliquotaPIS / 100), 2);
        }

        // Somar COFINS se tributado
        $cstCOFINS = $produto['cst_cofins'] ?? '01';
        if (in_array($cstCOFINS, ['01', '02'])) {
            $aliquotaCOFINS = (float)($produto['aliquota_cofins'] ?? 7.60);
            $totalCOFINS += round($valorProduto * ($aliquotaCOFINS / 100), 2);
        }
    }

    $std = new stdClass();
    $std->vBC = $totalICMSBC; // Base de c√°lculo real do ICMS
    $std->vICMS = $totalICMS; // ICMS real calculado
    $std->vICMSDeson = 0.00;
    $std->vBCST = 0.00;
    $std->vST = 0.00;
    $std->vProd = $totalProdutos; // Valor real dos produtos

    // ‚úÖ CORRE√á√ÉO CR√çTICA: Campos opcionais conforme documenta√ß√£o oficial NFe
    // Segundo mjailton.com.br/manualnfe - campos com valor zero devem ser omitidos
    // N√ÉO definir vFrete, vSeg, vOutro quando zero - biblioteca NFePHP omite automaticamente

    // Desconto: s√≥ incluir se houver valor
    $valorDesconto = (float)($totais['valor_desconto'] ?? 0);
    if ($valorDesconto > 0) {
        $std->vDesc = $valorDesconto;
    }

    $std->vII = 0.00;
    $std->vIPI = 0.00;
    $std->vPIS = $totalPIS; // PIS real calculado
    $std->vCOFINS = $totalCOFINS; // COFINS real calculado
    $std->vNF = $totalProdutos - $valorDesconto; // Valor final da NFe

    // Log dos totais calculados com dados reais
    error_log("NFE: Totais calculados - Produtos: R$ {$totalProdutos}, ICMS: R$ {$totalICMS}, PIS: R$ {$totalPIS}, COFINS: R$ {$totalCOFINS}, Total NFe: R$ " . $std->vNF);

    $make->tagICMSTot($std);

    // ‚úÖ DEBUG: Verificar dados da transportadora recebidos do frontend
    error_log("üîç DEBUG TRANSPORTADORA - Dados recebidos:");
    error_log("  - Modalidade: " . ($nfeData['transportadora']['modalidade_frete'] ?? 'N√ÉO INFORMADA'));
    error_log("  - ID: " . ($nfeData['transportadora']['transportadora_id'] ?? 'N√ÉO INFORMADO'));
    error_log("  - Nome: " . ($nfeData['transportadora']['transportadora_nome'] ?? 'N√ÉO INFORMADO'));
    error_log("  - Documento: " . ($nfeData['transportadora']['transportadora_documento'] ?? 'N√ÉO INFORMADO'));
    error_log("  - Endere√ßo: " . ($nfeData['transportadora']['transportadora_endereco'] ?? 'N√ÉO INFORMADO'));
    error_log("  - Cidade: " . ($nfeData['transportadora']['transportadora_cidade'] ?? 'N√ÉO INFORMADA'));
    error_log("  - UF: " . ($nfeData['transportadora']['transportadora_uf'] ?? 'N√ÉO INFORMADA'));
    error_log("  - IE: " . ($nfeData['transportadora']['transportadora_ie'] ?? 'N√ÉO INFORMADA'));
    error_log("  - Ve√≠culo Placa: " . ($nfeData['transportadora']['veiculo_placa'] ?? 'N√ÉO INFORMADA'));
    error_log("  - Ve√≠culo UF: " . ($nfeData['transportadora']['veiculo_uf'] ?? 'N√ÉO INFORMADA'));
    error_log("  - Volumes Qtd: " . ($nfeData['transportadora']['volumes_quantidade'] ?? 'N√ÉO INFORMADA'));
    error_log("  - Volumes Esp√©cie: " . ($nfeData['transportadora']['volumes_especie'] ?? 'N√ÉO INFORMADA'));
    error_log("  - Volumes Marca: " . ($nfeData['transportadora']['volumes_marca'] ?? 'N√ÉO INFORMADA'));
    error_log("  - Volumes Numera√ß√£o: " . ($nfeData['transportadora']['volumes_numeracao'] ?? 'N√ÉO INFORMADA'));
    error_log("  - Volumes Peso Bruto: " . ($nfeData['transportadora']['volumes_peso_bruto'] ?? 'N√ÉO INFORMADO'));
    error_log("  - Volumes Peso L√≠quido: " . ($nfeData['transportadora']['volumes_peso_liquido'] ?? 'N√ÉO INFORMADO'));

    // Transporte (M√âTODO NATIVO) - OBRIGAT√ìRIO antes do pagamento
    $std = new stdClass();

    // Transporte (M√âTODO NATIVO) - OBRIGAT√ìRIO conforme documenta√ß√£o oficial
    // Conforme mjailton.com.br/manualnfe/tag/detalhe/91 - Tag transp √© obrigat√≥ria
    $std = new stdClass();

    // ‚úÖ CORRE√á√ÉO: Verificar se h√° dados de transportadora informados
    $transportadoraData = $nfeData['transportadora'] ?? [];
    $temTransportadora = !empty($transportadoraData) &&
                        !empty($transportadoraData['modalidade_frete']) &&
                        $transportadoraData['modalidade_frete'] !== '9';

    if ($temTransportadora) {
        // Usar modalidade informada quando h√° transportadora
        $std->modFrete = $transportadoraData['modalidade_frete'];
        error_log("‚úÖ NFe - Modalidade de frete informada: " . $std->modFrete);
    } else {
        // Usar modalidade 9 (Sem Ocorr√™ncia de Transporte) quando n√£o h√° transportadora
        $std->modFrete = 9;
        error_log("‚úÖ NFe - Modalidade de frete: 9 (Sem Ocorr√™ncia de Transporte)");
    }

    logDetalhado("TRANSPORTADORA_DADOS_RECEBIDOS", "Dados da transportadora processados", [
        'tem_transportadora' => $temTransportadora,
        'modFrete' => $std->modFrete,
        'transportadora_completa' => $transportadoraData
    ]);

    logDetalhado("TRANSPORTADORA_TAG_INICIO", "Iniciando cria√ß√£o da tag transp");
    try {
        $make->tagtransp($std);
        logDetalhado("TRANSPORTADORA_TAG_CRIADA", "Tag transp criada com sucesso", [
            'modFrete' => $std->modFrete
        ]);

        error_log("‚úÖ TRANSP: Tag transp criada com modFrete = " . $std->modFrete);

    } catch (Exception $e) {
        logDetalhado("TRANSPORTADORA_TAG_ERRO", "Erro ao criar tag transp", [
            'erro' => $e->getMessage(),
            'linha' => $e->getLine(),
            'arquivo' => $e->getFile(),
            'modFrete_enviado' => $std->modFrete ?? 'N√ÉO DEFINIDO'
        ]);
        throw $e;
    }

    // ‚úÖ REGRA FISCAL NFe: S√≥ incluir dados da transportadora se modalidade ‚â† 9 E transportadora selecionada
    $modalidadeFrete = $std->modFrete;

    if ($modalidadeFrete !== '9' && !empty($nfeData['transportadora']['transportadora_id']) && !empty($nfeData['transportadora']['transportadora_nome'])) {
        $stdTransportadora = new stdClass();
        $stdTransportadora->xNome = $nfeData['transportadora']['transportadora_nome'];

        // Verificar se √© CNPJ ou CPF baseado no tamanho do documento
        $documento = preg_replace('/[^0-9]/', '', $nfeData['transportadora']['transportadora_documento'] ?? '');
        if (strlen($documento) == 14) {
            $stdTransportadora->CNPJ = $documento;
            $stdTransportadora->CPF = null;
        } elseif (strlen($documento) == 11) {
            $stdTransportadora->CPF = $documento;
            $stdTransportadora->CNPJ = null;
        } else {
            // Se n√£o tem documento v√°lido, usar apenas o nome
            $stdTransportadora->CNPJ = null;
            $stdTransportadora->CPF = null;
        }

        // ‚úÖ CORRIGIDO: Endere√ßo da transportadora com campos obrigat√≥rios
        $stdTransportadora->xEnder = $nfeData['transportadora']['transportadora_endereco'] ?? '';
        $stdTransportadora->xMun = $nfeData['transportadora']['transportadora_cidade'] ?? '';
        $stdTransportadora->UF = $nfeData['transportadora']['transportadora_uf'] ?? '';

        // IE da transportadora (obrigat√≥rio se aplic√°vel)
        $ieTransportadora = $nfeData['transportadora']['transportadora_ie'] ?? '';
        if (!empty($ieTransportadora) && strtoupper($ieTransportadora) !== 'ISENTO') {
            $stdTransportadora->IE = $ieTransportadora;
        } else {
            $stdTransportadora->IE = null; // N√£o informar se for isento ou vazio
        }

        $make->tagtransporta($stdTransportadora);

        error_log("‚úÖ NFe - Transportadora adicionada: " . $nfeData['transportadora']['transportadora_nome'] . " (Modalidade: $modalidadeFrete)");

        // ‚úÖ ADICIONADO: Tag de ve√≠culo (se informado)
        if (!empty($nfeData['transportadora']['veiculo_placa'])) {
            $stdVeiculo = new stdClass();
            $stdVeiculo->placa = $nfeData['transportadora']['veiculo_placa'];
            $stdVeiculo->UF = $nfeData['transportadora']['veiculo_uf'] ?? '';
            $stdVeiculo->RNTC = $nfeData['transportadora']['veiculo_rntc'] ?? null;

            $make->tagveicTransp($stdVeiculo);
            error_log("‚úÖ NFe - Ve√≠culo adicionado: Placa " . $stdVeiculo->placa . " (" . $stdVeiculo->UF . ")");
        }

        // ‚úÖ ADICIONADO: Tag de volumes (se informado)
        if (!empty($nfeData['transportadora']['volumes_quantidade']) && !empty($nfeData['transportadora']['volumes_especie'])) {
            $stdVolume = new stdClass();
            $stdVolume->item = 1; // N√∫mero do volume
            $stdVolume->qVol = (int)$nfeData['transportadora']['volumes_quantidade'];
            $stdVolume->esp = $nfeData['transportadora']['volumes_especie'];

            // ‚úÖ ADICIONADO: Campos marca e numera√ß√£o
            $stdVolume->marca = !empty($nfeData['transportadora']['volumes_marca']) ?
                $nfeData['transportadora']['volumes_marca'] : null;
            $stdVolume->nVol = !empty($nfeData['transportadora']['volumes_numeracao']) ?
                $nfeData['transportadora']['volumes_numeracao'] : null;

            // ‚úÖ ADICIONADO: Peso l√≠quido e bruto
            $stdVolume->pesoL = !empty($nfeData['transportadora']['volumes_peso_liquido']) ?
                (float)$nfeData['transportadora']['volumes_peso_liquido'] : null;
            $stdVolume->pesoB = !empty($nfeData['transportadora']['volumes_peso_bruto']) ?
                (float)$nfeData['transportadora']['volumes_peso_bruto'] : null;

            $make->tagvol($stdVolume);
            error_log("‚úÖ NFe - Volume adicionado: " . $stdVolume->qVol . " " . $stdVolume->esp .
                     ($stdVolume->marca ? " (Marca: " . $stdVolume->marca . ")" : "") .
                     ($stdVolume->nVol ? " (Num: " . $stdVolume->nVol . ")" : ""));
        }
    } else {
        if ($modalidadeFrete === '9') {
            error_log("‚ÑπÔ∏è NFe - Modalidade 9 (Sem Ocorr√™ncia de Transporte): Transportadora n√£o inclu√≠da conforme regra fiscal");
        } else {
            error_log("‚ÑπÔ∏è NFe - Nenhuma transportadora selecionada para modalidade: $modalidadeFrete");
        }
    }

    // Pagamento (M√âTODO NATIVO) - Conforme documenta√ß√£o fiscal
    // 1. PRIMEIRO: Criar grupo PAG (container)
    $std = new stdClass();
    $std->vTroco = null; // null para NFe (modelo 55), 0.00 para NFCe (modelo 65)
    $make->tagpag($std);

    // 2. DEPOIS: Criar detalhes do pagamento dentro do grupo PAG
    $std = new stdClass();
    $std->indPag = 0; // 0=√Ä vista, 1=√Ä prazo

    // ‚úÖ CORRE√á√ÉO CR√çTICA: Para finalidade 4 (devolu√ß√£o), usar "90 - Sem Pagamento"
    if ($finalidade === '4') {
        $std->tPag = '90'; // 90=Sem Pagamento (espec√≠fico para devolu√ß√£o)
        $std->vPag = 0.00; // Valor zero para devolu√ß√£o
        error_log("‚úÖ Pagamento configurado para devolu√ß√£o: tPag=90 (Sem Pagamento), vPag=0.00");
    } else {
        $std->tPag = '01'; // 01=Dinheiro (conforme tabela fiscal)
        $std->vPag = $totalProdutos - (float)($totais['valor_desconto'] ?? 0); // Usar valor calculado
        error_log("‚úÖ Pagamento configurado para venda normal: tPag=01, vPag=" . $std->vPag);
    }

    $make->tagdetPag($std);

    // Informa√ß√µes Adicionais (M√âTODO NATIVO) - ANTES DE GERAR XML
    $informacaoAdicional = $nfeData['informacao_adicional'] ?? '';

    // ‚úÖ CORRE√á√ÉO: Adicionar chaves de refer√™ncia √†s informa√ß√µes complementares para aparecer na DANFE
    $chavesRefTexto = '';
    if (!empty($chavesRef)) {
        $chavesRefTexto = "\n\nDOCUMENTOS FISCAIS REFERENCIADOS:\n";
        foreach ($chavesRef as $index => $chaveRef) {
            $chave = $chaveRef['chave'] ?? '';
            if (!empty($chave)) {
                $chavesRefTexto .= "NFe: " . $chave . "\n";
            }
        }
        error_log("‚úÖ Chaves de refer√™ncia adicionadas √†s informa√ß√µes complementares para DANFE");
    }

    // ‚úÖ ADICIONAR: Intermediador √†s informa√ß√µes complementares para aparecer na DANFE
    $intermediadorTexto = '';
    if (!empty($nfeData['intermediador']) && !empty($nfeData['intermediador']['nome']) && !empty($nfeData['intermediador']['cnpj'])) {
        $cnpjFormatado = preg_replace('/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/', '$1.$2.$3/$4-$5', $nfeData['intermediador']['cnpj']);
        $intermediadorTexto = "\n\nINTERMEDIADOR DA TRANSACAO:\n";
        $intermediadorTexto .= "Nome: " . $nfeData['intermediador']['nome'] . "\n";
        $intermediadorTexto .= "CNPJ: " . $cnpjFormatado;
        error_log("‚úÖ Intermediador adicionado √†s informa√ß√µes complementares para DANFE");
    }

    // Combinar informa√ß√£o adicional com chaves de refer√™ncia e intermediador
    $informacaoCompleta = trim($informacaoAdicional . $chavesRefTexto . $intermediadorTexto);

    if (!empty($informacaoCompleta)) {
        $std = new stdClass();
        $std->infCpl = $informacaoCompleta;
        $make->taginfAdic($std);
        error_log("NFE: Informa√ß√£o adicional inclu√≠da: " . substr($informacaoCompleta, 0, 100) . "...");
    } else {
        error_log("NFE: Nenhuma informa√ß√£o adicional fornecida");
    }

    // ‚úÖ INTERMEDIADOR DA TRANSA√á√ÉO (YB01, YB02, YB03) - Nota T√©cnica 2020.006
    if (!empty($nfeData['intermediador']) && !empty($nfeData['intermediador']['nome']) && !empty($nfeData['intermediador']['cnpj'])) {
        error_log("üîç DEBUG INTERMEDIADOR - Dados recebidos:");
        error_log("  - Nome: " . $nfeData['intermediador']['nome']);
        error_log("  - CNPJ: " . $nfeData['intermediador']['cnpj']);

        // Validar CNPJ do intermediador
        $cnpjIntermediador = preg_replace('/[^0-9]/', '', $nfeData['intermediador']['cnpj']);
        if (strlen($cnpjIntermediador) !== 14) {
            throw new Exception('CNPJ do intermediador deve ter 14 d√≠gitos');
        }

        // Criar tag do intermediador conforme especifica√ß√£o SEFAZ
        $stdIntermed = new stdClass();
        $stdIntermed->CNPJ = $cnpjIntermediador; // YB02 - CNPJ do Intermediador da Transa√ß√£o
        $stdIntermed->idCadIntTran = $nfeData['intermediador']['nome']; // YB03 - Nome/Identificador do intermediador

        $make->tagIntermed($stdIntermed);

        error_log("‚úÖ NFe - Intermediador da transa√ß√£o adicionado:");
        error_log("  - CNPJ: " . $cnpjIntermediador);
        error_log("  - Nome: " . $nfeData['intermediador']['nome']);
        error_log("  - Tags XML: YB01 (infIntermed), YB02 (CNPJ), YB03 (idCadIntTran)");
    } else {
        error_log("‚ÑπÔ∏è NFe - Nenhum intermediador informado - XML sem grupo infIntermed");
    }

    // ‚úÖ VERIFICAR ERROS DA BIBLIOTECA ANTES DE GERAR XML
    $errors = $make->getErrors();
    if (!empty($errors)) {
        logDetalhado("BIBLIOTECA_ERROS_DETECTADOS", "Erros encontrados na biblioteca NFePHP", [
            'erros' => $errors,
            'total_erros' => count($errors)
        ]);
        throw new Exception('Erros na estrutura da NFe: ' . implode('; ', $errors));
    }

    // ‚úÖ VALIDA√á√ÉO FINAL CONFORME DOCUMENTA√á√ÉO OFICIAL NFe
    // Verificar se todas as tags obrigat√≥rias est√£o presentes antes de gerar XML final
    try {
        // ‚úÖ DEBUG CR√çTICO: Verificar erros da biblioteca antes de gerar XML
        $errorsBeforeXML = $make->getErrors();
        if (!empty($errorsBeforeXML)) {
            error_log("‚ùå ERROS NA BIBLIOTECA ANTES DE GERAR XML:");
            foreach ($errorsBeforeXML as $error) {
                error_log("  - " . $error);
            }
        }

        error_log("üîç TENTANDO GERAR XML PRELIMINAR PARA VALIDA√á√ÉO...");
        $xmlPreliminar = $make->getXML();
        error_log("‚úÖ XML PRELIMINAR GERADO - Tamanho: " . strlen($xmlPreliminar) . " bytes");

        // ‚úÖ SALVAR XML PRELIMINAR PARA DEBUG
        $xmlPreliminarPath = "/tmp/nfe_preliminar_" . date('Y-m-d_H-i-s') . ".xml";
        file_put_contents($xmlPreliminarPath, $xmlPreliminar);
        error_log("üîç XML PRELIMINAR SALVO EM: " . $xmlPreliminarPath);

        // ‚úÖ PREVIEW DO XML PRELIMINAR
        $xmlPreview = substr($xmlPreliminar, 0, 3000);
        error_log("üîç XML PRELIMINAR PREVIEW (primeiros 3000 chars):");
        error_log($xmlPreview);

        // Tags obrigat√≥rias conforme mjailton.com.br/manualnfe
        $validacaoFinal = [
            'transp' => strpos($xmlPreliminar, '<transp>') !== false,
            'modFrete' => strpos($xmlPreliminar, '<modFrete>') !== false,
            'imposto' => strpos($xmlPreliminar, '<imposto>') !== false,
            'icms_ou_icmssn' => strpos($xmlPreliminar, '<ICMS>') !== false || strpos($xmlPreliminar, '<ICMSSN>') !== false,
            'pis' => strpos($xmlPreliminar, '<PIS>') !== false,
            'cofins' => strpos($xmlPreliminar, '<COFINS>') !== false
        ];

        // ‚úÖ LOG DETALHADO DA VALIDA√á√ÉO
        error_log("üîç VALIDA√á√ÉO DETALHADA DAS TAGS:");
        foreach ($validacaoFinal as $tag => $encontrada) {
            $status = $encontrada ? '‚úÖ' : '‚ùå';
            error_log("  - {$tag}: {$status}");
        }

        $tagsAusentes = [];
        foreach ($validacaoFinal as $tag => $presente) {
            if (!$presente) {
                $tagsAusentes[] = $tag;
            }
        }

        if (!empty($tagsAusentes)) {
            error_log("‚ùå VALIDA√á√ÉO FINAL FALHOU - Tags obrigat√≥rias ausentes: " . implode(', ', $tagsAusentes));
            error_log("üìä DIAGN√ìSTICO DETALHADO:");
            error_log("  - Produtos processados: {$contadorTags['produtos']}");
            error_log("  - Tags IMPOSTO criadas: {$contadorTags['impostos']}");
            error_log("  - Tags ICMS/ICMSSN criadas: {$contadorTags['icms']}");
            error_log("  - Tags PIS criadas: {$contadorTags['pis']}");
            error_log("  - Tags COFINS criadas: {$contadorTags['cofins']}");
            
            logDetalhado("VALIDACAO_FINAL_ERRO", "Tags obrigat√≥rias ausentes no XML", [
                'tags_ausentes' => $tagsAusentes,
                'validacao_completa' => $validacaoFinal,
                'contador_tags' => $contadorTags,
                'total_produtos' => count($produtos)
            ]);
            throw new Exception('XML inv√°lido - Tags obrigat√≥rias ausentes: ' . implode(', ', $tagsAusentes));
        }

        error_log("‚úÖ VALIDA√á√ÉO FINAL: Todas as tags obrigat√≥rias est√£o presentes");
        error_log("üìä TAGS VALIDADAS COM SUCESSO:");
        error_log("  - Produtos: {$contadorTags['produtos']}");
        error_log("  - IMPOSTO: {$contadorTags['impostos']}");
        error_log("  - ICMS/ICMSSN: {$contadorTags['icms']}");
        error_log("  - PIS: {$contadorTags['pis']}");
        error_log("  - COFINS: {$contadorTags['cofins']}");
        error_log("  - TRANSP: ‚úÖ");
        error_log("  - modFrete: ‚úÖ");
        
        logDetalhado("VALIDACAO_FINAL_SUCESSO", "Todas as tags obrigat√≥rias validadas", [
            'validacao_completa' => $validacaoFinal,
            'contador_tags' => $contadorTags,
            'total_produtos' => count($produtos)
        ]);

    } catch (Exception $xmlError) {
        error_log("ERRO: Falha ao processar XML: " . $xmlError->getMessage());
        error_log("üìä ESTADO DOS CONTADORES NO MOMENTO DO ERRO:");
        error_log("  - Produtos: {$contadorTags['produtos']}");
        error_log("  - IMPOSTO: {$contadorTags['impostos']}");
        error_log("  - ICMS/ICMSSN: {$contadorTags['icms']}");
        error_log("  - PIS: {$contadorTags['pis']}");
        error_log("  - COFINS: {$contadorTags['cofins']}");
        // SEGUINDO AS 4 LEIS NFe - SEM DADOS FICT√çCIOS
        throw new Exception("Erro ao processar resposta da SEFAZ: " . $xmlError->getMessage());
    }
    // GERAR XML (M√âTODO NATIVO)
    try {
        logDetalhado("XML_GERACAO_INICIO", "Iniciando gera√ß√£o do XML");
        $xml = $make->getXML();

        // ‚úÖ SALVAR XML PARA DEBUG
        $xmlDebugPath = "/tmp/nfe_debug_" . date('Y-m-d_H-i-s') . ".xml";
        file_put_contents($xmlDebugPath, $xml);

        // ‚úÖ VALIDA√á√ÉO DETALHADA DO XML CONFORME DOCUMENTA√á√ÉO OFICIAL
        $validacaoXML = [
            'tamanho_xml' => strlen($xml),
            'tem_imposto' => strpos($xml, '<imposto>') !== false,
            'tem_transp' => strpos($xml, '<transp>') !== false,
            'tem_modFrete' => strpos($xml, '<modFrete>') !== false,
            'tem_cest' => strpos($xml, '<CEST>') !== false,
            'tem_icms' => strpos($xml, '<ICMS>') !== false || strpos($xml, '<ICMSSN>') !== false,
            'tem_pis' => strpos($xml, '<PIS>') !== false,
            'tem_cofins' => strpos($xml, '<COFINS>') !== false,
            'xml_debug_path' => $xmlDebugPath
        ];

        // ‚úÖ LOG DETALHADO PARA DEBUG
        error_log("üîç VALIDA√á√ÉO XML DETALHADA:");
        foreach ($validacaoXML as $campo => $valor) {
            if ($campo !== 'xml_debug_path') {
                $status = is_bool($valor) ? ($valor ? '‚úÖ' : '‚ùå') : $valor;
                error_log("  - {$campo}: {$status}");
            }
        }

        // ‚úÖ SALVAR PREVIEW DO XML PARA AN√ÅLISE
        $xmlPreview = substr($xml, 0, 2000);
        error_log("üîç XML PREVIEW (primeiros 2000 chars):");
        error_log($xmlPreview);

        logDetalhado("XML_GERACAO_SUCESSO", "XML gerado com sucesso", $validacaoXML);
    } catch (Exception $xmlError) {
        // Capturar erros da biblioteca
        $errors = $make->getErrors();
        $errorMessage = 'Erro na estrutura da NFe: ' . $xmlError->getMessage();
        if (!empty($errors)) {
            $errorMessage .= ' | Erros detalhados: ' . implode('; ', $errors);
        }
        logDetalhado("XML_GERACAO_ERRO", "Erro ao gerar XML", [
            'erro' => $xmlError->getMessage(),
            'erros_biblioteca' => $errors
        ]);
        throw new Exception($errorMessage);
    }

    // Verificar se h√° erros na estrutura
    if (!$xml) {
        $errors = $make->getErrors();
        throw new Exception('XML n√£o foi gerado. Erros: ' . implode('; ', $errors));
    }
    
    // ASSINAR XML (M√âTODO NATIVO)
    $xmlAssinado = $tools->signNFe($xml);
    
    // ENVIAR PARA SEFAZ (M√âTODO NATIVO)
    try {
        $response = $tools->sefazEnviaLote([$xmlAssinado], 1);
    } catch (Exception $sefazError) {
        throw new Exception("Erro ao enviar para SEFAZ: " . $sefazError->getMessage());
    }

    // PROCESSAR RESPOSTA (M√âTODO NATIVO)

    try {
        // Analisar XML de resposta SOAP com tratamento robusto

        // Verificar se a resposta n√£o est√° vazia
        if (empty($response)) {
            throw new Exception('Resposta SEFAZ est√° vazia');
        }

        // Remover declara√ß√£o XML problem√°tica se existir
        $cleanResponse = preg_replace('/^<\?xml[^>]*\?>/', '', trim($response));

        // Tentar carregar XML com diferentes abordagens
        $xml = false;

        // Tentativa 1: XML direto
        if (!$xml) {
            $xml = @simplexml_load_string($response);
        }

        // Tentativa 2: Limpar declara√ß√£o XML e tentar novamente
        if (!$xml) {
            $xml = @simplexml_load_string($cleanResponse);
        }

        // Tentativa 3: Usar regex como fallback (mais simples e confi√°vel)
        if (!$xml) {

            // N√£o usar DOMDocument para evitar problemas com libxml
            // Ir direto para extra√ß√£o via regex
        }

        // Se SimpleXML falhou, usar regex diretamente (mais confi√°vel)
        if ($xml === false) {

            // Tentar extrair informa√ß√µes b√°sicas usando regex
            preg_match('/<cStat>(\d+)<\/cStat>/', $response, $statusMatch);
            preg_match('/<xMotivo>([^<]+)<\/xMotivo>/', $response, $motivoMatch);
            preg_match('/<nRec>([^<]+)<\/nRec>/', $response, $reciboMatch);
            preg_match('/<chNFe>([^<]+)<\/chNFe>/', $response, $chaveMatch);
            preg_match('/<nProt>([^<]+)<\/nProt>/', $response, $protocoloMatch);

            if (!empty($statusMatch)) {
                $status = $statusMatch[1];
                $motivo = $motivoMatch[1] ?? 'Motivo n√£o encontrado';
                $recibo = $reciboMatch[1] ?? 'RECIBO_NAO_ENCONTRADO';
                $chave = $chaveMatch[1] ?? 'CHAVE_NAO_ENCONTRADA';
                $protocolo = !empty($protocoloMatch[1]) ? $protocoloMatch[1] : null;

            } else {
                error_log("ERRO: N√£o foi poss√≠vel extrair dados da resposta SEFAZ");
                throw new Exception('Erro ao processar resposta da SEFAZ - dados n√£o encontrados');
            }
        }

        // Extrair dados da consulta do recibo
        // A estrutura da consulta do recibo √© diferente do envio
        $cStatRecibo = $xml->xpath('//cStat') ?: $xml->xpath('//*[local-name()="cStat"]');
        $xMotivoRecibo = $xml->xpath('//xMotivo') ?: $xml->xpath('//*[local-name()="xMotivo"]');

        // Para consulta de recibo, o protocolo est√° em protNFe/infProt/nProt dentro de cada NFe
        $nProtRecibo = $xml->xpath('//protNFe/infProt/nProt') ?:
                      $xml->xpath('//infProt/nProt') ?:
                      $xml->xpath('//nProt') ?:
                      $xml->xpath('//*[local-name()="protNFe"]//*[local-name()="infProt"]//*[local-name()="nProt"]') ?:
                      $xml->xpath('//*[local-name()="nProt"]');

        $status = !empty($cStatRecibo) ? (string)$cStatRecibo[0] : 'DESCONHECIDO';
        $motivo = !empty($xMotivoRecibo) ? (string)$xMotivoRecibo[0] : 'Sem motivo';
        $chave = 'CHAVE_NAO_ENCONTRADA'; // Ser√° definida posteriormente
        $recibo = 'RECIBO_NAO_ENCONTRADO'; // Ser√° definida posteriormente
        $protocolo = null; // Inicializar protocolo

        // SEGUINDO DOCUMENTA√á√ÉO OFICIAL SEFAZ - Status 104 = "Lote processado"
        // Conforme MOC: "cStat=104, com os resultados individuais de processamento das NF-e"
        if ($status === '104') {
            error_log("üìã STATUS 104 - Lote processado. Buscando resultado individual da NFe...");

            // Buscar status espec√≠fico da NFe dentro do elemento protNFe/infProt
            // Conforme documenta√ß√£o: protNFe/infProt/cStat e protNFe/infProt/nProt
            $cStatNFe = $xml->xpath('//protNFe/infProt/cStat') ?:
                       $xml->xpath('//*[local-name()="protNFe"]//*[local-name()="infProt"]//*[local-name()="cStat"]');

            $xMotivoNFe = $xml->xpath('//protNFe/infProt/xMotivo') ?:
                         $xml->xpath('//*[local-name()="protNFe"]//*[local-name()="infProt"]//*[local-name()="xMotivo"]');

            $nProtNFe = $xml->xpath('//protNFe/infProt/nProt') ?:
                       $xml->xpath('//*[local-name()="protNFe"]//*[local-name()="infProt"]//*[local-name()="nProt"]');

            if (!empty($cStatNFe)) {
                $status = (string)$cStatNFe[0];
                $motivo = !empty($xMotivoNFe) ? (string)$xMotivoNFe[0] : $motivo;
                $chave = 'CHAVE_EXTRAIDA_DO_XML'; // Ser√° extra√≠da posteriormente
                $protocolo = !empty($nProtNFe) ? (string)$nProtNFe[0] : null;

                error_log("‚úÖ RESULTADO INDIVIDUAL DA NFe ENCONTRADO:");
                error_log("  - Status NFe: {$status}");
                error_log("  - Motivo NFe: {$motivo}");
                error_log("  - Chave NFe: {$chave}");
                error_log("  - Protocolo NFe: " . ($protocolo ? $protocolo : 'N√ÉO ENCONTRADO'));
            } else {
                error_log("‚ùå ERRO: N√£o foi poss√≠vel encontrar resultado individual da NFe no lote processado");
            }
        }

        error_log("üìã RESULTADO FINAL - Status: {$status} - {$motivo}");

    } catch (Exception $consultaError) {
        error_log("‚ùå ERRO ao consultar recibo: " . $consultaError->getMessage());
        throw new Exception("Erro ao consultar recibo da SEFAZ: " . $consultaError->getMessage());
    }

    // VALIDA√á√ÉO CR√çTICA - SEGUINDO AS 4 LEIS NFe
    // Verificar se NFe foi realmente autorizada (Status 100)
    if ($status !== '100') {
        error_log("‚ùå NFe N√ÉO AUTORIZADA - Status: {$status} - {$motivo}");

        $erroTraduzido = traduzirErroSefaz($status, $motivo);

        throw new Exception(json_encode([
            'tipo' => 'erro_sefaz',
            'titulo' => $erroTraduzido['titulo'],
            'descricao' => $erroTraduzido['descricao'],
            'solucao' => $erroTraduzido['solucao'],
            'detalhes_tecnicos' => [
                'status' => $status,
                'motivo' => $motivo
            ]
        ]));
    }

    // Verificar se protocolo real existe
    if (empty($protocolo)) {
        error_log("‚ùå PROTOCOLO AUSENTE - NFe n√£o pode ser considerada autorizada");
        throw new Exception("Protocolo n√£o encontrado. NFe n√£o foi autorizada pela SEFAZ.");
    }

    // Validar formato do protocolo (15 d√≠gitos num√©ricos)
    if (!preg_match('/^\d{15}$/', $protocolo)) {
        error_log("‚ùå PROTOCOLO INV√ÅLIDO: {$protocolo} - Deve ter 15 d√≠gitos num√©ricos");
        throw new Exception("Protocolo inv√°lido recebido da SEFAZ: {$protocolo}");
    }

    error_log("‚úÖ NFe VALIDADA - Status: {$status}, Protocolo: {$protocolo}");

    // Resultado da resposta (apenas dados reais validados)
    $resultado = [
        'chave' => $chave,
        'protocolo' => $protocolo,
        'recibo' => $recibo,
        'status' => $status,
        'motivo' => $motivo,
        'response_xml' => $response
    ];
    
    // Extrair chave real do XML gerado
    $chaveReal = null;
    try {
        $xmlDoc = new DOMDocument();
        $xmlDoc->loadXML($xmlAssinado);

        // Buscar o atributo Id da tag infNFe
        $infNFeNodes = $xmlDoc->getElementsByTagName('infNFe');
        if ($infNFeNodes->length > 0) {
            $idAttribute = $infNFeNodes->item(0)->getAttribute('Id');
            if ($idAttribute && strlen($idAttribute) >= 44) {
                // Extrair os √∫ltimos 44 caracteres (chave da NFe)
                $chaveReal = substr($idAttribute, -44);
            }
        }
    } catch (Exception $xmlParseError) {
        error_log("AVISO: N√£o foi poss√≠vel extrair chave do XML: " . $xmlParseError->getMessage());
    }

    // Usar chave real se encontrada, sen√£o manter a original
    $chaveParaSalvar = $chaveReal ?: $chave;

    // üî• NOVA ESTRUTURA COM MODELO DE DOCUMENTO
    // Salvar XML em arquivo - ESTRUTURA ORGANIZADA COM AMBIENTE E MODELO
    $ambienteTexto = $ambiente == 1 ? 'producao' : 'homologacao';
    $modelo = '55'; // NFe por padr√£o, futuramente ser√° din√¢mico para NFCe
    $xmlDir = "../storage/xml/empresa_{$empresaId}/{$ambienteTexto}/{$modelo}/Autorizados/" . date('Y/m');
    if (!is_dir($xmlDir)) {
        mkdir($xmlDir, 0755, true);
        error_log("üìÅ Diret√≥rio de NFes autorizadas criado: {$xmlDir}");
    }

    // Garantir que o XML tenha declara√ß√£o XML v√°lida
    $xmlComDeclaracao = $xmlAssinado;
    $xmlTrimmed = trim($xmlAssinado);
    if (substr($xmlTrimmed, 0, 5) !== '<?xml') {
        $xmlComDeclaracao = '<?xml version="1.0" encoding="UTF-8"?>' . "\n" . $xmlAssinado;
    }

    $xmlPath = "{$xmlDir}/{$chaveParaSalvar}.xml";
    file_put_contents($xmlPath, $xmlComDeclaracao);


    // Gerar DANFE (PDF) - Sempre gerar PDF quando XML for v√°lido
    $pdfPath = null;
    try {
        error_log("PDF: Iniciando gera√ß√£o DANFE - Status: {$status}");

        if (!class_exists('\NFePHP\DA\NFe\Danfe')) {
            throw new Exception('Classe Danfe n√£o encontrada - instale sped-da');
        }

        error_log("PDF: Classe Danfe encontrada");
        error_log("PDF: Tamanho XML: " . strlen($xmlComDeclaracao) . " bytes");

        $danfe = new \NFePHP\DA\NFe\Danfe($xmlComDeclaracao);

        $danfe->debugMode(false);
        $danfe->creditsIntegratorFooter('Sistema Nexo PDV');

        error_log("PDF: Danfe configurado, iniciando render");
        $pdfContent = $danfe->render();

        if (empty($pdfContent)) {
            throw new Exception('PDF gerado est√° vazio');
        }

        error_log("PDF: PDF gerado com sucesso - " . strlen($pdfContent) . " bytes");

        // Salvar PDF - ESTRUTURA ORGANIZADA COM AMBIENTE E MODELO (igual aos XMLs)
        $pdfDir = "../storage/pdf/empresa_{$empresaId}/{$ambienteTexto}/{$modelo}/Autorizados/" . date('Y/m');
        if (!is_dir($pdfDir)) {
            mkdir($pdfDir, 0755, true);
            error_log("PDF: Diret√≥rio de PDFs autorizados criado: {$pdfDir}");
        }

        $pdfPath = "{$pdfDir}/{$chaveParaSalvar}.pdf";
        $result = file_put_contents($pdfPath, $pdfContent);

        if ($result === false) {
            throw new Exception('Falha ao salvar arquivo PDF');
        }

        // Verificar se arquivo foi salvo corretamente
        if (!file_exists($pdfPath) || filesize($pdfPath) < 1000) {
            throw new Exception('PDF salvo mas arquivo inv√°lido ou muito pequeno');
        }

        error_log("PDF: PDF salvo com sucesso em: {$pdfPath}");
        error_log("PDF: Tamanho do arquivo: " . filesize($pdfPath) . " bytes");

    } catch (Exception $pdfError) {
        error_log("ERRO CR√çTICO: Falha ao gerar PDF: " . $pdfError->getMessage());
        error_log("ERRO CR√çTICO: Arquivo: " . $pdfError->getFile());
        error_log("ERRO CR√çTICO: Linha: " . $pdfError->getLine());

        // Em homologa√ß√£o, n√£o falhar por causa do PDF
        if ($ambiente == 2) {
            error_log("AVISO: PDF falhou em homologa√ß√£o, continuando sem PDF");
            $pdfPath = null;
        } else {
            throw new Exception("Erro ao gerar PDF DANFE: " . $pdfError->getMessage());
        }
    }

    // ‚úÖ SUCESSO: NFe emitida com sucesso
    echo json_encode([
        'success' => true,
        'message' => 'NFe emitida com sucesso',
        'data' => [
            'chave' => $chaveParaSalvar, // Usar chave real extra√≠da do XML
            'protocolo' => $protocolo,
            'recibo' => $recibo ?? 'RECIBO_NAO_ENCONTRADO',
            'status' => $status ?? 'DESCONHECIDO',
            'motivo' => $motivo ?? 'Sem motivo',
            'xml_path' => $xmlPath,
            'pdf_path' => $pdfPath,
            'numero' => $identificacao['numero'] ?? null,
            'serie' => $identificacao['serie'] ?? null,
            'data_autorizacao' => date('Y-m-d H:i:s'),
            'xml' => base64_encode($xmlAssinado)
        ],
        'resultado_sefaz' => $resultado
    ], JSON_UNESCAPED_UNICODE);

} catch (Exception $e) {
    logDetalhado('FATAL_ERROR', 'Erro cr√≠tico na emiss√£o da NFe', [
        'error' => $e->getMessage(),
        'file' => $e->getFile(),
        'line' => $e->getLine(),
        'trace' => $e->getTraceAsString()
    ]);

    // Determinar tipo de erro e c√≥digo HTTP apropriado
    $errorMessage = $e->getMessage();
    $httpCode = 500;
    $errorType = 'server_error';

    // Erros de valida√ß√£o (dados do usu√°rio)
    if (strpos($errorMessage, 'obrigat√≥rio') !== false ||
        strpos($errorMessage, 'inv√°lido') !== false ||
        strpos($errorMessage, 'deve ter') !== false ||
        strpos($errorMessage, 'n√£o encontrado') !== false) {
        $httpCode = 400;
        $errorType = 'user_error';
    }

    // Erros da SEFAZ
    if (strpos($errorMessage, 'SEFAZ') !== false ||
        strpos($errorMessage, 'Status') !== false ||
        strpos($errorMessage, 'Rejei√ß√£o') !== false) {
        $httpCode = 400;
        $errorType = 'sefaz_error';
    }

    http_response_code($httpCode);
    echo json_encode([
        'success' => false,
        'error' => $errorMessage,
        'error_type' => $errorType,
        'timestamp' => date('Y-m-d H:i:s'),
        'debug_info' => [
            'file' => basename($e->getFile()),
            'line' => $e->getLine(),
            'step' => 'FATAL_ERROR'
        ]
    ], JSON_UNESCAPED_UNICODE);
}
?>
