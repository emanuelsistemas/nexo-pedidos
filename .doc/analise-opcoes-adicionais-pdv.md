# üìä An√°lise: Op√ß√µes Adicionais no PDV

## üîç **Estrutura Atual das Op√ß√µes Adicionais**

### **Hierarquia Identificada:**

```
grupos
‚îî‚îÄ‚îÄ produtos
    ‚îî‚îÄ‚îÄ produtos_opcoes_adicionais (relaciona produto com op√ß√£o)
        ‚îî‚îÄ‚îÄ opcoes_adicionais (ex: "Tamanho", "Sabor", "Extras")
            ‚îî‚îÄ‚îÄ opcoes_adicionais_itens (ex: "Grande", "M√©dio", "Pequeno")
                ‚îî‚îÄ‚îÄ produtos_opcoes_adicionais_itens (relaciona produto com item espec√≠fico)
```

### **üìã Tabelas Analisadas:**

#### **1. opcoes_adicionais** (Categorias de Op√ß√µes)
- `id`, `nome`, `empresa_id`, `quantidade_minima`
- **Exemplo:** "Tamanho", "Sabor", "Extras"

#### **2. opcoes_adicionais_itens** (Itens das Op√ß√µes)
- `id`, `nome`, `preco`, `opcao_id`
- **Exemplo:** "Grande (R$ 5,00)", "M√©dio (R$ 3,00)", "Pequeno (R$ 0,00)"

#### **3. produtos_opcoes_adicionais** (Produto ‚Üí Op√ß√£o)
- `id`, `produto_id`, `opcao_id`
- **Relaciona:** Pizza ‚Üí Tamanho

#### **4. produtos_opcoes_adicionais_itens** (Produto ‚Üí Item Espec√≠fico)
- `id`, `produto_id`, `item_id`
- **Relaciona:** Pizza ‚Üí Grande, Pizza ‚Üí M√©dio

#### **5. pedidos_itens_adicionais** (Padr√£o Atual nos Pedidos)
- `id`, `pedido_item_id`, `item_adicional_id`, `quantidade`, `valor_unitario`

## üéØ **Cen√°rios de Uso no PDV**

### **Exemplo Pr√°tico:**
```
Produto: Pizza Margherita (R$ 25,00)
‚îú‚îÄ‚îÄ Tamanho (obrigat√≥rio)
‚îÇ   ‚îú‚îÄ‚îÄ Pequena (R$ 0,00)
‚îÇ   ‚îú‚îÄ‚îÄ M√©dia (R$ 5,00)
‚îÇ   ‚îî‚îÄ‚îÄ Grande (R$ 10,00)
‚îú‚îÄ‚îÄ Extras (opcional)
‚îÇ   ‚îú‚îÄ‚îÄ Queijo Extra (R$ 3,00)
‚îÇ   ‚îú‚îÄ‚îÄ Azeitona (R$ 2,00)
‚îÇ   ‚îî‚îÄ‚îÄ Bacon (R$ 4,00)
‚îî‚îÄ‚îÄ Borda (opcional)
    ‚îú‚îÄ‚îÄ Catupiry (R$ 6,00)
    ‚îî‚îÄ‚îÄ Cheddar (R$ 5,00)
```

**Venda no PDV:**
- Pizza Margherita Grande + Queijo Extra + Borda Catupiry
- **C√°lculo:** R$ 25,00 + R$ 10,00 + R$ 3,00 + R$ 6,00 = **R$ 44,00**

## ü§î **Op√ß√µes de Implementa√ß√£o no PDV**

### **Op√ß√£o 1: Tabelas Separadas (RECOMENDADA)**

#### **Vantagens:**
- ‚úÖ **Consist√™ncia:** Segue o mesmo padr√£o dos pedidos
- ‚úÖ **Normaliza√ß√£o:** Estrutura bem organizada
- ‚úÖ **Flexibilidade:** F√°cil manuten√ß√£o e consultas
- ‚úÖ **Rastreabilidade:** Cada adicional √© rastre√°vel
- ‚úÖ **Relat√≥rios:** Relat√≥rios detalhados por adicional
- ‚úÖ **Performance:** Consultas otimizadas com √≠ndices

#### **Estrutura Proposta:**
```sql
-- Tabela para itens adicionais do PDV
CREATE TABLE pdv_itens_adicionais (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  empresa_id UUID NOT NULL,
  usuario_id UUID NOT NULL,
  pdv_item_id UUID NOT NULL, -- FK para pdv_itens

  -- Refer√™ncia ao adicional
  item_adicional_id UUID NOT NULL, -- FK para opcoes_adicionais_itens
  nome_adicional TEXT NOT NULL, -- Cache do nome

  -- Valores
  quantidade NUMERIC(10,3) NOT NULL DEFAULT 1,
  valor_unitario NUMERIC(10,2) NOT NULL,
  valor_total NUMERIC(10,2) NOT NULL,

  -- Origem (para rastreabilidade)
  origem_adicional TEXT DEFAULT 'manual', -- 'manual', 'pedido_importado'
  pedido_item_adicional_origem_id UUID, -- Se veio de pedido

  -- Controle
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### **Op√ß√£o 2: Campo JSONB (N√ÉO RECOMENDADA)**

#### **Desvantagens:**
- ‚ùå **Consultas Complexas:** Dif√≠cil fazer relat√≥rios
- ‚ùå **Performance:** Consultas em JSONB s√£o mais lentas
- ‚ùå **Integridade:** Sem valida√ß√£o de FK
- ‚ùå **Manuten√ß√£o:** Dif√≠cil de manter e debugar

## üèóÔ∏è **Implementa√ß√£o Recomendada**

### **1. Criar Tabela PDV_ITENS_ADICIONAIS**

```sql
CREATE TABLE pdv_itens_adicionais (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  empresa_id UUID NOT NULL REFERENCES empresas(id) ON DELETE CASCADE,
  usuario_id UUID NOT NULL REFERENCES usuarios(id) ON DELETE RESTRICT,
  pdv_item_id UUID NOT NULL REFERENCES pdv_itens(id) ON DELETE CASCADE,

  -- Adicional
  item_adicional_id UUID NOT NULL REFERENCES opcoes_adicionais_itens(id),
  nome_adicional TEXT NOT NULL,

  -- Valores
  quantidade NUMERIC(10,3) NOT NULL DEFAULT 1,
  valor_unitario NUMERIC(10,2) NOT NULL,
  valor_total NUMERIC(10,2) NOT NULL,

  -- Origem
  origem_adicional TEXT DEFAULT 'manual',
  pedido_item_adicional_origem_id UUID REFERENCES pedidos_itens_adicionais(id),

  -- Controle
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### **2. √çndices para Performance**

```sql
CREATE INDEX idx_pdv_itens_adicionais_empresa_id ON pdv_itens_adicionais(empresa_id);
CREATE INDEX idx_pdv_itens_adicionais_pdv_item_id ON pdv_itens_adicionais(pdv_item_id);
CREATE INDEX idx_pdv_itens_adicionais_item_adicional_id ON pdv_itens_adicionais(item_adicional_id);
CREATE INDEX idx_pdv_itens_adicionais_origem ON pdv_itens_adicionais(origem_adicional);
```

### **3. Constraints de Valida√ß√£o**

```sql
ALTER TABLE pdv_itens_adicionais ADD CONSTRAINT chk_pdv_itens_adicionais_origem
CHECK (origem_adicional IN ('manual', 'pedido_importado'));

ALTER TABLE pdv_itens_adicionais ADD CONSTRAINT chk_pdv_itens_adicionais_quantidade_positiva
CHECK (quantidade > 0);

ALTER TABLE pdv_itens_adicionais ADD CONSTRAINT chk_pdv_itens_adicionais_valor_positivo
CHECK (valor_unitario >= 0);
```

## üìä **Benef√≠cios da Implementa√ß√£o**

### **1. Rastreabilidade Completa**
- Cada adicional pode ser rastreado at√© sua origem
- Relat√≥rios detalhados de vendas por adicional
- Controle de estoque de adicionais (se necess√°rio)

### **2. Importa√ß√£o de Pedidos**
- Adicionais dos pedidos s√£o preservados
- Relacionamento mantido com pedido original
- Possibilidade de editar adicionais no PDV

### **3. Relat√≥rios Avan√ßados**
```sql
-- Relat√≥rio: Adicionais mais vendidos
SELECT
  nome_adicional,
  SUM(quantidade) as quantidade_total,
  SUM(valor_total) as valor_total
FROM pdv_itens_adicionais
WHERE empresa_id = 'empresa-uuid'
GROUP BY nome_adicional
ORDER BY quantidade_total DESC;
```

### **4. C√°lculo de Totais**
```sql
-- Total do item com adicionais
SELECT
  pi.nome_produto,
  pi.valor_total_item as valor_produto,
  COALESCE(SUM(pia.valor_total), 0) as valor_adicionais,
  pi.valor_total_item + COALESCE(SUM(pia.valor_total), 0) as valor_final
FROM pdv_itens pi
LEFT JOIN pdv_itens_adicionais pia ON pi.id = pia.pdv_item_id
WHERE pi.pdv_id = 'pdv-uuid'
GROUP BY pi.id, pi.nome_produto, pi.valor_total_item;
```

## üöÄ **Pr√≥ximos Passos**

1. **Criar tabela pdv_itens_adicionais**
2. **Implementar relacionamentos e √≠ndices**
3. **Atualizar frontend do PDV** para suportar adicionais
4. **Implementar importa√ß√£o** de adicionais dos pedidos
5. **Criar relat√≥rios** espec√≠ficos para adicionais
6. **Testar integra√ß√£o** completa

## üí° **Considera√ß√µes Importantes**

### **Performance:**
- √çndices otimizados para consultas frequentes
- Desnormaliza√ß√£o controlada (cache do nome)

### **Integridade:**
- FKs garantem consist√™ncia
- Constraints validam dados

### **Flexibilidade:**
- Estrutura permite futuras expans√µes
- Compat√≠vel com sistema de pedidos existente

---

## ‚úÖ **IMPLEMENTA√á√ÉO CONCLU√çDA**

**Data:** 30/01/2025
**Status:** ‚úÖ Tabela `pdv_itens_adicionais` Criada com Sucesso
**Migra√ß√£o:** `20250130000001_add_pdv_itens_adicionais.sql`

### **üìã Estrutura Implementada:**
- ‚úÖ **Tabela:** pdv_itens_adicionais criada
- ‚úÖ **Campos:** Todos os campos necess√°rios implementados
- ‚úÖ **Relacionamentos:** FKs para pdv_itens, opcoes_adicionais_itens, pedidos_itens_adicionais
- ‚úÖ **√çndices:** 8 √≠ndices criados para performance otimizada
- ‚úÖ **Constraints:** 5 constraints de valida√ß√£o implementadas
- ‚úÖ **Triggers:** Trigger para updated_at autom√°tico
- ‚úÖ **Fun√ß√µes:** Fun√ß√£o para calcular valor total com adicionais
- ‚úÖ **Documenta√ß√£o:** Coment√°rios em tabela e campos principais
- ‚úÖ **Soft Delete:** Suporte completo a exclus√£o l√≥gica

### **üîó Relacionamentos Criados:**
- ‚úÖ pdv_itens_adicionais ‚Üí empresas (empresa_id)
- ‚úÖ pdv_itens_adicionais ‚Üí usuarios (usuario_id)
- ‚úÖ pdv_itens_adicionais ‚Üí pdv_itens (pdv_item_id) ON DELETE CASCADE
- ‚úÖ pdv_itens_adicionais ‚Üí opcoes_adicionais_itens (item_adicional_id)
- ‚úÖ pdv_itens_adicionais ‚Üí pedidos_itens_adicionais (origem)
- ‚úÖ pdv_itens_adicionais ‚Üí usuarios (deletado_por)

### **üìä Funcionalidades Dispon√≠veis:**
- ‚úÖ **Rastreabilidade:** Origem manual ou importada de pedidos
- ‚úÖ **C√°lculo Autom√°tico:** Fun√ß√£o `calcular_valor_total_item_pdv()`
- ‚úÖ **Performance:** √çndices otimizados para consultas frequentes
- ‚úÖ **Integridade:** Constraints garantem dados v√°lidos
- ‚úÖ **Auditoria:** Controle completo de cria√ß√£o, edi√ß√£o e exclus√£o

### **üí° Exemplo Pr√°tico de Uso:**

```sql
-- 1. Inserir item principal no PDV
INSERT INTO pdv_itens (
  empresa_id, usuario_id, pdv_id, produto_id,
  nome_produto, quantidade, valor_unitario, valor_total_item
) VALUES (
  'empresa-uuid', 'usuario-uuid', 'pdv-uuid', 'pizza-uuid',
  'Pizza Margherita', 1, 25.00, 25.00
) RETURNING id as pdv_item_id;

-- 2. Adicionar op√ß√µes adicionais
INSERT INTO pdv_itens_adicionais (
  empresa_id, usuario_id, pdv_item_id, item_adicional_id,
  nome_adicional, quantidade, valor_unitario, valor_total
) VALUES
  ('empresa-uuid', 'usuario-uuid', 'pdv-item-uuid', 'tamanho-grande-uuid',
   'Tamanho Grande', 1, 10.00, 10.00),
  ('empresa-uuid', 'usuario-uuid', 'pdv-item-uuid', 'queijo-extra-uuid',
   'Queijo Extra', 1, 3.00, 3.00),
  ('empresa-uuid', 'usuario-uuid', 'pdv-item-uuid', 'borda-catupiry-uuid',
   'Borda Catupiry', 1, 6.00, 6.00);

-- 3. Calcular valor total do item (produto + adicionais)
SELECT calcular_valor_total_item_pdv('pdv-item-uuid'); -- Retorna: 44.00
```

### **üìä Consultas √öteis:**

```sql
-- Listar item com seus adicionais
SELECT
  pi.nome_produto,
  pi.valor_total_item as valor_produto,
  pia.nome_adicional,
  pia.valor_total as valor_adicional
FROM pdv_itens pi
LEFT JOIN pdv_itens_adicionais pia ON pi.id = pia.pdv_item_id
WHERE pi.pdv_id = 'pdv-uuid' AND pia.deletado = FALSE;

-- Relat√≥rio de adicionais mais vendidos
SELECT
  nome_adicional,
  COUNT(*) as vezes_vendido,
  SUM(quantidade) as quantidade_total,
  SUM(valor_total) as receita_total
FROM pdv_itens_adicionais
WHERE empresa_id = 'empresa-uuid'
  AND deletado = FALSE
  AND created_at >= '2025-01-01'
GROUP BY nome_adicional
ORDER BY receita_total DESC;
```

### **üöÄ Pr√≥ximos Passos:**
1. **Atualizar Frontend PDV** para suportar adicionais
2. **Implementar Importa√ß√£o** de adicionais dos pedidos
3. **Criar Relat√≥rios** espec√≠ficos para adicionais
4. **Testar Integra√ß√£o** completa

**Recomenda√ß√£o Final:** ‚úÖ **IMPLEMENTADO - Tabela separada `pdv_itens_adicionais`**
**Motivo:** Consist√™ncia, performance e flexibilidade superiores ‚úÖ **CONFIRMADO**
