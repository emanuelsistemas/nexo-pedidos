# üì± CARD√ÅPIO DIGITAL - DOCUMENTA√á√ÉO COMPLETA

## üìã VIS√ÉO GERAL

O Card√°pio Digital √© uma funcionalidade que permite √†s empresas disponibilizar seus produtos atrav√©s de uma p√°gina p√∫blica acess√≠vel via QR Code, com integra√ß√£o direta ao WhatsApp para pedidos.

### üéØ Funcionalidades Principais
- ‚úÖ **P√°gina p√∫blica √∫nica** por empresa via URL personalizada
- ‚úÖ **QR Code real** gerado automaticamente
- ‚úÖ **Tema claro/escuro** configur√°vel
- ‚úÖ **Integra√ß√£o WhatsApp** para pedidos
- ‚úÖ **Filtros por categoria** de produtos
- ‚úÖ **Fotos dos produtos** (quando dispon√≠veis)
- ‚úÖ **Valida√ß√£o de URL √∫nica** entre empresas

---

## üóÑÔ∏è ESTRUTURA DO BANCO DE DADOS

### Tabela: `pdv_config`
```sql
-- Campos relacionados ao Card√°pio Digital
cardapio_digital BOOLEAN DEFAULT FALSE           -- Habilita/desabilita card√°pio
cardapio_url_personalizada VARCHAR(100) DEFAULT '' -- URL √∫nica da empresa
modo_escuro_cardapio BOOLEAN DEFAULT FALSE       -- Tema escuro/claro
```

### Relacionamentos
- `pdv_config.empresa_id` ‚Üí `empresas.id` (FK)
- `produtos.empresa_id` ‚Üí `empresas.id` (FK)
- `produto_fotos.produto_id` ‚Üí `produtos.id` (FK)
- `grupos.id` ‚Üí `produtos.grupo_id` (FK)

---

## üìÅ ESTRUTURA DE ARQUIVOS

### Frontend
```
src/pages/public/CardapioPublicoPage.tsx    # P√°gina p√∫blica do card√°pio
src/pages/dashboard/ConfiguracoesPage.tsx   # Configura√ß√µes do PDV
```

### Migra√ß√µes
```
supabase/migrations/20250703000000_add_cardapio_url_personalizada.sql
supabase/migrations/20250703000001_add_modo_escuro_cardapio.sql
```

---

## üîß CONFIGURA√á√ÉO DA EMPRESA

### 1. Habilita√ß√£o do Card√°pio Digital
**Local**: Configura√ß√µes ‚Üí PDV ‚Üí Geral
```typescript
// Campo: cardapio_digital
<input
  type="checkbox"
  checked={pdvConfig.cardapio_digital}
  onChange={(e) => handlePdvConfigChange('cardapio_digital', e.target.checked)}
/>
```

### 2. URL Personalizada
**Local**: Configura√ß√µes ‚Üí PDV ‚Üí Card√°pio Digital (aba)
```typescript
// Campo: cardapio_url_personalizada
<input
  type="text"
  value={cardapioUrlPersonalizada}
  onChange={(e) => setCardapioUrlPersonalizada(e.target.value.toLowerCase().replace(/[^a-z0-9-]/g, ''))}
  placeholder="nome-da-sua-loja"
  maxLength={50}
/>
```

### 3. Modo Escuro
**Local**: Configura√ß√µes ‚Üí PDV ‚Üí Card√°pio Digital (aba)
```typescript
// Campo: modo_escuro_cardapio
<input
  type="checkbox"
  checked={pdvConfig.modo_escuro_cardapio}
  onChange={(e) => handlePdvConfigChange('modo_escuro_cardapio', e.target.checked)}
/>
```

---

## üåê P√ÅGINA P√öBLICA

### URL Pattern
```
https://nexodev.emasoftware.app/cardapio/[slug-personalizado]
```

### Roteamento
```typescript
// App.tsx
<Route path="/cardapio/:slug" element={<CardapioPublicoPage />} />
```

### Fluxo de Carregamento
1. **Buscar configura√ß√£o PDV** pelo slug
2. **Buscar dados da empresa** via empresa_id
3. **Buscar produtos ativos** da empresa
4. **Buscar fotos** dos produtos (tabela produto_fotos)
5. **Buscar grupos** dos produtos
6. **Processar e exibir** dados

---

## üîç CONSULTAS SUPABASE

### 1. Buscar Empresa por Slug
```typescript
const { data: pdvConfigData } = await supabase
  .from('pdv_config')
  .select('empresa_id, cardapio_url_personalizada, modo_escuro_cardapio')
  .eq('cardapio_url_personalizada', slug)
  .eq('cardapio_digital', true)
  .single();
```

### 2. Buscar Dados da Empresa
```typescript
const { data: empresaData } = await supabase
  .from('empresas')
  .select('id, razao_social, nome_fantasia, whatsapp, endereco, numero, bairro, cidade, estado')
  .eq('id', pdvConfigData.empresa_id)
  .single();
```

### 3. Buscar Produtos
```typescript
const { data: produtosData } = await supabase
  .from('produtos')
  .select('id, nome, descricao, preco, grupo_id, ativo')
  .eq('empresa_id', pdvConfigData.empresa_id)
  .eq('ativo', true)
  .order('nome');
```

### 4. Buscar Fotos dos Produtos
```typescript
const { data: fotosResult } = await supabase
  .from('produto_fotos')
  .select('produto_id, url, principal')
  .in('produto_id', produtosIds)
  .eq('principal', true);
```

---

## üé® SISTEMA DE TEMAS

### Tema Claro (padr√£o)
```css
bg-gray-50      /* Fundo principal */
bg-white        /* Cards/containers */
text-gray-900   /* Texto principal */
border-gray-200 /* Bordas */
```

### Tema Escuro (quando habilitado)
```css
bg-gray-900     /* Fundo principal */
bg-gray-800     /* Cards/containers */
text-white      /* Texto principal */
border-gray-700 /* Bordas */
```

### Aplica√ß√£o Din√¢mica
```typescript
const modoEscuro = pdvConfigData.modo_escuro_cardapio;
setConfig(prev => ({ ...prev, modo_escuro: modoEscuro }));

// Uso na interface
className={`${config.modo_escuro ? 'bg-gray-900' : 'bg-gray-50'}`}
```

---

## üì± QR CODE

### Biblioteca Utilizada
```bash
npm install qrcode @types/qrcode
```

### Gera√ß√£o do QR Code
```typescript
import QRCode from 'qrcode';

const generateQRCode = async (url: string) => {
  const qrCodeDataUrl = await QRCode.toDataURL(url, {
    width: 200,
    margin: 2,
    color: {
      dark: '#000000',
      light: '#FFFFFF'
    }
  });
  setQrCodeDataUrl(qrCodeDataUrl);
};
```

### Funcionalidades
- ‚úÖ **Download** como PNG
- ‚úÖ **Impress√£o** formatada
- ‚úÖ **C√≥pia** do link
- ‚úÖ **Visualiza√ß√£o** em nova aba

---

## üí¨ INTEGRA√á√ÉO WHATSAPP

### Formato da URL
```typescript
const whatsapp = empresa.whatsapp.replace(/\D/g, '');
const mensagem = `Ol√°! Gostaria de fazer um pedido:\n\n*${produto.nome}*\n${formatarPreco(produto.preco)}`;
const url = `https://wa.me/55${whatsapp}?text=${encodeURIComponent(mensagem)}`;
```

### Valida√ß√µes
- ‚úÖ Verificar se empresa tem WhatsApp cadastrado
- ‚úÖ Limpar formata√ß√£o do n√∫mero
- ‚úÖ Adicionar c√≥digo do pa√≠s (+55)
- ‚úÖ Codificar mensagem para URL

---

## üõ°Ô∏è VALIDA√á√ÉO DE URL √öNICA

### Verifica√ß√£o em Tempo Real
```typescript
const verificarDisponibilidadeUrl = async (url: string) => {
  const { data: urlExistente } = await supabase
    .from('pdv_config')
    .select('empresa_id')
    .eq('cardapio_url_personalizada', url.trim())
    .neq('empresa_id', usuarioData.empresa_id); // Excluir pr√≥pria empresa

  setUrlDisponivel(!urlExistente || urlExistente.length === 0);
};
```

### Valida√ß√£o no Salvamento
```typescript
// Verificar duplicatas antes de salvar
if (urlExistente) {
  showMessage('error', `O nome "${cardapioUrlPersonalizada}" j√° est√° sendo usado por outra empresa.`);
  return;
}
```

---

## üö® PROBLEMAS CONHECIDOS E SOLU√á√ïES

### 1. Erro "Card√°pio n√£o encontrado"
**Causa**: Consulta com JOIN complexo no Supabase
**Solu√ß√£o**: Fazer consultas separadas e processar localmente
```typescript
// ‚ùå N√£o funciona
.select(`empresa_id, empresas(nome, telefone)`)

// ‚úÖ Funciona
.select('empresa_id, cardapio_url_personalizada')
// Depois buscar empresa separadamente
```

### 2. Erro "column telefone does not exist"
**Causa**: Campo telefone n√£o existe na tabela empresas
**Solu√ß√£o**: Usar campo `whatsapp` em vez de `telefone`
```typescript
// ‚ùå N√£o existe
.select('telefone')

// ‚úÖ Existe
.select('whatsapp')
```

### 3. Erro "column foto_url does not exist"
**Causa**: Fotos est√£o em tabela separada `produto_fotos`
**Solu√ß√£o**: Buscar fotos separadamente e relacionar por `produto_id`
```typescript
// Buscar fotos separadamente
const { data: fotosResult } = await supabase
  .from('produto_fotos')
  .select('produto_id, url, principal')
  .in('produto_id', produtosIds)
  .eq('principal', true);
```

### 4. Campo "Modo Escuro" n√£o salva
**Causa**: Campo n√£o conectado ao estado e fun√ß√£o de salvamento
**Solu√ß√£o**: Conectar corretamente
```typescript
// ‚ùå N√£o funciona
<input defaultChecked={false} />

// ‚úÖ Funciona
<input 
  checked={pdvConfig.modo_escuro_cardapio}
  onChange={(e) => handlePdvConfigChange('modo_escuro_cardapio', e.target.checked)}
/>
```

---

## üîÑ FLUXO COMPLETO DE FUNCIONAMENTO

### 1. Configura√ß√£o (Admin)
1. Empresa acessa Configura√ß√µes ‚Üí PDV
2. Habilita "Card√°pio Digital"
3. Vai para aba "Card√°pio Digital"
4. Define URL personalizada (ex: "minha-pizzaria")
5. Configura modo escuro (opcional)
6. Sistema gera QR Code automaticamente

### 2. Acesso P√∫blico (Cliente)
1. Cliente escaneia QR Code ou acessa link direto
2. Sistema busca empresa pelo slug da URL
3. Carrega produtos, fotos e configura√ß√µes
4. Aplica tema (claro/escuro) conforme configura√ß√£o
5. Cliente navega pelo card√°pio
6. Cliente clica "Pedir via WhatsApp"
7. WhatsApp abre com mensagem pr√©-formatada

### 3. Isolamento Multi-tenant
- ‚úÖ Cada empresa tem URL √∫nica
- ‚úÖ Produtos isolados por empresa_id
- ‚úÖ Configura√ß√µes isoladas por empresa_id
- ‚úÖ Imposs√≠vel ver dados de outras empresas

---

## üß™ TESTES

### URLs de Teste
```
http://nexodev.emasoftware.app/cardapio/valesis  # Empresa de teste
```

### Cen√°rios de Teste
1. **URL v√°lida** ‚Üí Deve carregar card√°pio
2. **URL inv√°lida** ‚Üí Deve mostrar "Card√°pio n√£o encontrado"
3. **Card√°pio desabilitado** ‚Üí Deve mostrar erro
4. **Modo escuro habilitado** ‚Üí Deve aplicar tema escuro
5. **WhatsApp v√°lido** ‚Üí Deve abrir conversa
6. **URL duplicada** ‚Üí Deve impedir salvamento

---

## üìù PR√ìXIMAS MELHORIAS

### Funcionalidades Sugeridas
- [ ] **Hor√°rio de funcionamento** (mostrar se est√° aberto/fechado)
- [ ] **Categorias personalizadas** (ordena√ß√£o, cores)
- [ ] **Promo√ß√µes/descontos** destacados
- [ ] **Carrinho de compras** antes do WhatsApp
- [ ] **M√∫ltiplas fotos** por produto
- [ ] **Busca/filtro** de produtos
- [ ] **Compartilhamento social** do card√°pio
- [ ] **Analytics** de visualiza√ß√µes

### Melhorias T√©cnicas
- [ ] **Cache** das consultas para performance
- [ ] **Lazy loading** das imagens
- [ ] **PWA** (Progressive Web App)
- [ ] **SEO** otimizado por empresa
- [ ] **Compress√£o** autom√°tica de imagens

---

## üîó LINKS √öTEIS

- **Documenta√ß√£o Supabase**: https://supabase.com/docs
- **QR Code Library**: https://github.com/soldair/node-qrcode
- **WhatsApp API**: https://wa.me/
- **React Router**: https://reactrouter.com/

---

**üìÖ √öltima atualiza√ß√£o**: 03/07/2025  
**üë®‚Äçüíª Implementado por**: Augment Agent  
**üîÑ Status**: Funcional e em produ√ß√£o
